/*! cantas - v1.0.0 - 2014-07-07 */!function(){"use strict";var a=window.cantas||{};a.KEY_CODES={SPACE:32,COMMA:188,ENTER:13,BACKSPACE:8,LEFT_ARROW:37,RIGHT_ARROW:39},window.cantas=a}();var a=function(a){return a.sorting=!1,$(document).mousemove(function(b){return a.mouseX=b.pageX,a.mouseY=b.pageY}),a.refreshPositions=function(){return $(".board").sortable("refreshPositions"),$(".connectedSortable").sortable("refreshPositions")},a.refreshListSortable=function(){return $(".board").sortable({appendTo:"#wrapper",placeholder:"ui-state-highlight-list",tolerance:"pointer",revert:"100",handle:".list-header",delay:"75",distance:"7",scroll:!1,helper:"clone",start:function(b,c){var d=c.helper.width(),e=.9*c.helper.height();$(c.placeholder).width(d).height(e),$(this).attr("data-previndex",c.item.index()),a.sorting=!0,a.scrollWhileSorting()},stop:function(b,c){b.stopPropagation();var d=c.item.index(),e=$(this).attr("data-previndex");return $(this).removeAttr("data-previndex"),c.item.trigger("listdrop",[d,e]),_.defer(function(){return a.sorting=!1})}}),$(".board").sortable("refresh")},a.refreshCardSortable=function(){return $(".connectedSortable").sortable({connectWith:".connectedSortable",revert:"100",appendTo:"#wrapper",tolerance:"pointer",placeholder:"ui-state-highlight",delay:"75",distance:"7",items:".js-list-card",scroll:!1,helper:"clone",start:function(b,c){a.sorting=!0;var d=c.helper.height()+2;$(c.placeholder).height(d),a.scrollWhileSorting()},stop:function(b){return b.stopPropagation(),setTimeout(function(){return a.sorting=!1},50),a.scrollList=null},over:function(b,c){return a.scrollListFromUI(c)}}),$(".connectedSortable").sortable("refresh")},a.scrollWhileSorting=function(){if(a.sorting){var b=$(".board"),c=b.offset().left+30,d=b.offset().left+b.width()-30,e=b.offset().top+30,f=b.offset().top+b.height()-30;if(a.mouseX<c){var g=b.scrollLeft();b.scrollLeft(g-15)}else if(a.mouseX>d){var g=b.scrollLeft();b.scrollLeft(g+15)}else null!=a.scrollList&&null!=a.scrollList.scrollTop&&(a.mouseY<e?a.scrollList.scrollTop-=15:a.mouseY>f&&(a.scrollList.scrollTop+=15));return setTimeout(a.scrollWhileSorting,20)}},a.scrollListFromUI=function(b){return null!=b&&null!=b.placeholder?(a.scrollList=b.placeholder.parents(".list-content")[0],a.scrollList):void 0},a}(a||{});!function(a,b){"use strict";window.cantas=window.cantas||{};var c=cantas.utils||{};c.getCurrentBoardId=function(){return cantas.utils.getCurrentBoardModel().id},c.getCurrentBoardView=function(){return cantas.appRouter.currentView},c.getCurrentBoardModel=function(){return cantas.utils.getCurrentBoardView().model},c.getCardModelById=function(a){var b;return cantas.utils.getCurrentBoardModel().listCollection.every(function(c){return b=c.cardCollection.get(a),b?!1:!0}),b},c.getCurrentUser=function(){return cantas.user},c.getCurrentCommentStatus=function(){var a=cantas.utils.getCurrentBoardModel();return a.attributes.commentStatus},c.isBrowserVersionLow=function(){var a=cantas.utils.getBrowserVersionInfo(),b=(a.name,a.version),c=b.slice(0,b.indexOf(".")),d=!1;return a.chrome&&10>c?d=!0:a.firefox&&10>c?d=!0:a.safari&&6>c&&(d=!0),d},c.renderBrowserVesionPrompt=function(){var b=cantas.utils.getBrowserVersionInfo(),c=b.name,d=b.version;a(".force-alert").find("p").text("Your browser "+c+" "+d+" is too low to run Cantas stably. We recommend Chrome 10+, FireFox 10+, Safari 6+ etc.").end().find("a").text("Browser Support Matrix").prop("href","/standalonehelp#browserSupportMatrix").end().modal({backdrop:"static"})},c.renderTimeoutBox=function(){a("div.force-alert > div.alert-content > p").html("Caution: failed to sync with the Cantas server. Changes made now may not be saved."),a("div.force-alert").fadeIn("slow")},c.renderClearTimeoutBox=function(){a("div.force-alert > div.alert-content > p").html(""),a("div.force-alert").fadeOut("slow")},c.renderImportTrelloBox=function(){a(".force-alert").find("p").text("New content has been appended to the current board, please refresh to check out.").end().toggle()},c.randomWait=function(a,b){return Math.floor(a+Math.random()*b)},c.formatDate=function(a,b){var c=b||"YYYY-MM-DD HH:mm:ss Z";return moment(a).format(c)},c.calcPos=function(a){var c=65536,d=-1,e=a.length;if(e>0){var f=b.last(a.pluck("order"));d=f+c}else d+=c;return d},c.checkEmail=function(a){var b="^[a-z]([a-z0-9]*[-_]?[a-z0-9]+)*@([a-z0-9]*[-_]?[a-z0-9]+)+[\\.][a-z]{2,3}([\\.][a-z]{2})?$",c=new RegExp(b,"i");return c.test(a)},c.getBrowserVersionInfo=function(){var a={msie:!1,firefox:!1,opera:!1,safari:!1,name:"unknown",version:0},b=window.navigator.userAgent.toLowerCase();return/(msie|firefox|opera|chrome)\D+(\d[\d.]*)/.test(b)?(a[RegExp.$1]=!0,a.name=RegExp.$1,a.version=RegExp.$2):/version\D+(\d[\d.]*).*safari/.test(b)&&(a.safari=!0,a.name="safari",a.version=RegExp.$1),a},c.formatFileSize=function(a){return"number"!=typeof a?"":a>=1e9?(a/1e9).toFixed(2)+" GB":a>=1e6?(a/1e6).toFixed(2)+" MB":(a/1e3).toFixed(2)+" KB"};var d=function(b,c,d,e,f){c.fetch({data:f,success:function(c){var f=".choose-position > ul:eq("+e+") .js-move-items",g="a[data-itemid*='"+d+"']";b.$el.find(f).empty(),c.each(function(a){var c=new cantas.views.MoveItemView({model:a.toJSON()});b._childrenViews.push(c),b.$el.find(f).append(c.render().el)}),b.$el.find(g).parent("li").addClass("checked");var h=b.$el.find(g).closest("ul"),i=b.$el.find(g).parent("li"),j=0,k=i.prevAll();a.each(k,function(b,c){j+=a(c).outerHeight(!0)});var l=h.innerHeight();j>l?h.scrollTop(j):j+i.outerHeight(!0)>l&&(j=j+i.outerHeight(!0)-l,h.scrollTop(j))}})};c.renderMoveList=function(a,b,e,f){var g=a.boardCollection,h=b,i={},j=[];if(0===f){var k=c.getCurrentUser(),l={userId:k.id,$or:[{status:"available"},{status:"inviting"}]};a.boardMemberCollection.fetch({data:l,success:function(b){j=b.map(function(a){return a.get("boardId")}),i={isClosed:!1,$or:[{creatorId:k.id},{_id:{$in:j}}]},d(a,g,h,f,i)}})}1===f&&(g=a.listCollection,h=e,i={boardId:b,isArchived:!1},d(a,g,h,f,i))},c.renderMoveSearch=function(b){var c=a(b.target).val();a(b.target).parent().siblings().find(".js-move-items li").show(),a(b.target).parent().siblings().find(".js-move-items li a").not('[data-label*="'+c+'"]').parent().hide()},c.getOffsetX=function(b,c){var d=0;return b+a(c).outerWidth(!0)>a(window).width()&&(d=b+a(c).outerWidth(!0)-a(window).width()),d},c.getOffsetY=function(b,c){var d=0;return b+a(c).outerHeight(!0)>a(window).height()&&(d=b+a(c).outerHeight(!0)-a(window).height()),d},c.rememberMe=function(a,b){for(;b&&b.length>0;){var c=b.shift();void 0!==c&&c.collapse()}return b.push(a),b},c.forgetMe=function(a,b){return b.indexOf(a)>=0&&b.pop(),b},c.getQueryStringParam=function(a){var b=new RegExp("[?&]"+a+"=([^&]*)").exec(window.location.search);return b&&decodeURIComponent(b[1].replace(/\+/g," "))},c.getQueryStringParams=function(){return document.location.search.replace(/(^\?)/,"").split("&").map(function(a){return a=a.split("="),this[a[0]]=a[1],this}.bind({}))[0]},cantas.utils=c}(jQuery,_,Backbone),function(){"use strict";var a={"&":"&amp;","<":"&lt;",">":"&gt;"},b=function(b){return a[b]||b},c=cantas.utils||{};c.safeString=function(a){return a.replace(/[&<>]/g,b)},c.escapeString=function(a){return a.replace(/\n/g,"<br/>").replace(/ /g,"&nbsp;")},cantas.utils=c}(jQuery,_,Backbone),$(function(a,b){"use strict";window.cantas=window.cantas||{},cantas.models={};var c=window.cantas.settings?window.cantas.settings.socketIO.port:80;cantas.socket=io.connect(""+document.location.protocol+"//"+document.location.hostname+":"+c,{reconnect:!0,"max reconnection attempts":100,"max reconnection delay":32e3,"reconnection delay":cantas.utils.randomWait(100,1e3)}),cantas.views={},cantas.setTitle=function(a){window.document.title="Cantas | "+a},moment.lang("en",{calendar:{lastDay:"[Yesterday at] LT",sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",lastWeek:"[last] dddd [at] LT",nextWeek:"dddd [at] LT",sameElse:"DD/MM/YYYY"}}),b.mixin({compactObject:function(a){var c=b.clone(a);return b.each(c,function(a,b){a||delete c[b]}),c}})}(jQuery,_,Backbone)),function(a,b,c){"use strict";cantas.models.BaseModel=c.Model.extend({idAttribute:"_id",socket:cantas.socket,urlRoot:void 0,noIoBind:!1,url:function(){if(void 0===this.urlRoot||"string"!=typeof this.urlRoot)throw new TypeError("urlRoot is not well-defined.");return"/"+this.urlRoot+"/"+this.id},initialize:function(){this.noIoBind||(this.ioBind("update",this.serverChange,this),this.ioBind("delete",this.serverDelete,this))},serverChange:function(a){this.set(a)},serverDelete:function(){this.collection?this.collection.remove(this):this.trigger("remove",this)},modelCleanup:function(){return this.ioUnbindAll(),this},patch:function(a,b){var c=b||{};return c.patch=!0,this.save(a,c)},dispose:function(){return this.off(),this.noIoBind||this.ioUnbindAll(),this}}),cantas.models.BaseCollection=c.Collection.extend({socket:cantas.socket,noIoBind:!1,initialize:function(){this.ioBind("create",this.serverCreate,this)},serverCreate:function(a){this.add(a)},dispose:function(){return this.forEach(function(a){a.dispose()}),this.off(),this.noIoBind||this.ioUnbind("create",this.serverCreate),this}})}(jQuery,_,Backbone),function(a,b,c){"use strict";cantas.views.BaseView=c.View.extend({close:function(){this.model&&this.model.dispose(),this.remove()}})}(jQuery,_,Backbone),function(){"use strict";cantas.views.AppView=cantas.views.BaseView.extend({el:"body",events:{"keyup .js-search-form":"searchAction","submit .js-search-form":"searchAction","focus .js-search-form":"searchAction","click .quick-search":function(a){a.stopPropagation()}},initialize:function(){this.initNofiticationView(),this.initQuickSearchView()},initNofiticationView:function(){this.notificationView=new cantas.views.NotificationView,cantas.socket.on("/notification:create",function(a){new cantas.models.Notification(a);this.notificationView.notificationCollection.add(a)}.bind(this))},initQuickSearchView:function(){this.quickSearchView=new cantas.views.QuickSearchView({el:this.$(".quick-search-content")})},searchAction:function(a){var b=a.keyCode||a.which;if(27!==b&&13!==b){a.preventDefault();var c=this.$('.js-search-form [name="query"]').val();this.quickSearchView.search(c)}}})}(jQuery,_,Backbone),function(a,b){"use strict";cantas.views.SearchBaseView=cantas.views.BaseView.extend({isSearching:!1,maxCards:-1,maxBoards:-1,cardListColumns:4,boardListTemplate:jade.compile(a("#template-search-board-list-view").text()),initialize:function(){b.bindAll(this,"openBoard"),this.query=null,this.cardViews=[],this.cardCollection=(new cantas.models.CardCollection).setPage(1).setPerPage(this.maxCards).setSort({created:-1,title:1}),this.boardCollection=new cantas.models.BoardCollection,this.listenTo(this.boardCollection,"sync reset add remove",this.renderBoardResults),this.render()},render:function(){this.$el.html(this.template()),this.renderCardResults()},renderCardResults:function(){var a=this.$(".card-archive");this.cardListView=new cantas.views.CardIndexView({el:a,collection:this.cardCollection,columns:this.cardListColumns,paginate:this.paginate||!1,perPage:this.maxCards}).render()},renderBoardResults:function(){var a=this.$(".board-archive").empty(),c=this.boardCollection.toJSON();this.maxBoards>0&&(c=b.first(c,this.maxBoards)),a.html(this.boardListTemplate({boards:c}))},openBoard:function(b){b.preventDefault(),this.closeQuickSearch(),cantas.navigateTo(a(b.target).attr("href"))},getCards:function(b){var c=a.Deferred();return this.cardCollection.setFilters({$or:[{creatorId:cantas.user.id},{assignees:cantas.user.id},{subscribeUserIds:cantas.user.id}],title:{$regex:b,$options:"gi"}}).fetch({reset:!0,success:c.resolve}),c.promise()},getBoards:function(b){var c=a.Deferred();return this.boardCollection.fetch({data:{$or:[{isPublic:!0},{creatorId:cantas.user.id}],title:{$regex:b,$options:"gi"}},success:c.resolve}),c.promise()},close:function(){this.cardListView.close(),this.remove()},remove:function(){return this.$el.empty(),this.undelegateEvents(),this.stopListening(),this}}),cantas.views.SearchView=cantas.views.SearchBaseView.extend({el:".content",query:null,maxCards:20,maxBoards:-1,paginate:!0,template:jade.compile(a("#template-search-view").text()),search:function(a){this.query=a,this.getCards(a),this.getBoards(a)}})}(jQuery,_,Backbone),function(a,b){"use strict";cantas.views.QuickSearchView=cantas.views.SearchBaseView.extend({maxCards:3,maxBoards:4,cardListColumns:3,template:jade.compile(a("#template-quick-search-view").text()),events:{"click .js-view-board":"openBoard","click .card":"closeQuickSearch",click:function(a){a.stopPropagation()},"click .js-full-results":"fullResults"},initialize:function(){b.bindAll(this,"keyupAction","openQuickSearch","closeQuickSearch","fullResults"),cantas.views.SearchBaseView.prototype.initialize.call(this)},keyupAction:function(a){var b=a.keyCode||a.which;27===b&&this.closeQuickSearch(),13===b&&this.fullResults(a)},fullResults:function(a){a.preventDefault(),cantas.navigateTo("search/"+this.query),this.closeQuickSearch()},setTitle:function(a){this.$("h3").html(a?'Search results for "'+a+'"':"Search Results")},openQuickSearch:function(){this.isSearching||(this.isSearching=!0,this.$el.addClass("active"),a(".content").addClass("muted"),a("body").on("keyup.quickSearch",this.keyupAction),a("body").on("click.quickSearch",this.closeQuickSearch))},closeQuickSearch:function(){this.isSearching&&(this.isSearching=!1,this.$el.removeClass("active"),a(".content").removeClass("muted"),a("input.quick-search").blur(),a("body").off("click.quickSearch"),a("body").off("keyup.quickSearch"))},renderCardCount:function(a){var b=this;this.cardCollection.fetchTotal(a).then(function(a){var c=a<b.maxCards?a:b.maxCards;b.$(".cards-title .count").text(c+"/"+a)})},renderBoardCount:function(a){var b=this;this.boardCollection.fetchTotal(a).then(function(a){var c=a<b.maxBoards?a:b.maxBoards;b.$(".boards-title .count").text(c+"/"+a)})},search:b.debounce(function(a){this.query=a;var b=this;a&&a.length?(this.$(".no-results").hide(),this.$(".results-container").show(),this.setTitle(a),this.openQuickSearch(),this.getCards(a).then(function(){b.renderCardCount(a)}),this.getBoards(a).then(function(){b.renderBoardCount(a)}),this.$(".js-full-results").show()):(this.$(".no-results").show(),this.$(".results-container").hide(),this.$(".js-full-results").hide(),this.setTitle())},50)})}(jQuery,_,Backbone),function(){"use strict";cantas.models.Activity=cantas.models.BaseModel.extend({idAttribute:"_id",socket:cantas.socket,urlRoot:"activity",url:function(){return"/activity/"+this.id}}),cantas.models.ActivityCollection=cantas.models.BaseCollection.extend({url:"/activity",model:cantas.models.Activity,comparator:function(a){return a.get("createdOn")}})}(jQuery,_,Backbone),function(a,b,c){"use strict";cantas.views.ActivityView=c.View.extend({tagName:"li",initialize:function(){this.render()},render:function(){var a=b.template(this.getTemplate(),this.model.attributes);return this.$el.html(a),this},getTemplate:function(){return a("#activity-item-template").html()}}),cantas.views.ActivityCollectionView=c.View.extend({initialize:function(){this.collection.on("add",this.showOneActivity,this),this.activitiesContainer=a(".activity.side-bar").find("ul").first(),this.showActivitiesOnlyOnce(),a("#toggleActivities").on("click",this,this.toggleActivities),a(".activity .collapse-bar").on("click",this,this.toggleActivities),a(".activity header a").on("click",this,this.toggleActivities)},getCurrentBoardId:function(){return cantas.utils.getCurrentBoardModel().id},toggleActivities:function(){a(".activity").toggle("slide",{direction:"right"},"fast")},showOneActivity:function(a){var b=new cantas.views.ActivityView({model:a});this.activitiesContainer.prepend(b.el)},showActivitiesOnlyOnce:function(){this.activitiesLoaded||(this.activitiesLoaded=!0,this.collection.fetch({data:{boardId:this.getCurrentBoardId()}}))},remove:function(){return this.collection.dispose(),this.undelegateEvents(),this.stopListening(),this}})}(jQuery,_,Backbone),function(){"use strict";cantas.models.Notification=cantas.models.BaseModel.extend({idAttribute:"_id",socket:cantas.socket,urlRoot:"notification",url:function(){return"/notification/"+this.id}}),cantas.models.NotificationCollection=cantas.models.BaseCollection.extend({url:"/notification",model:cantas.models.Notification,comparator:function(a,b){return a.get("created")>b.get("created")?-1:a.get("created")<b.get("created")?1:0}})}(jQuery,_,Backbone),function(a,b,c){"use strict";window.cantas=window.cantas||{},cantas.user=cantas.user||{},cantas.views.NotificationView=c.View.extend({el:".js-notification-menu",template:jade.compile(a("#template-notification-menu-view").text()),events:{"click .js-dropdown-toggle":"renderOnePageItems","hide.bs.dropdown":"clearPageContent","click .js-show-more":"renderOnePageItems","click .js-all-read":"markAllAsRead","click .js-dropdown-content li.unread":"hasRead"},initialize:function(){var a=this;this.notificationCollection=new cantas.models.NotificationCollection,this.listenTo(this.notificationCollection,"add",this.renderItem),this.listenTo(this.notificationCollection,"change:isUnread",this.setToRead),this.notificationItemViews=[],this.notificationCollection.fetch({data:{isUnread:!0,userId:cantas.user.id},reset:!0,success:function(){a.render()}}),this.pageSize=10,this.pageBegin=0},render:function(){return this.$el.html(this.template()),this._updateReminder(),this},clearPageContent:function(){var a=this.$(".js-dropdown-content");a.children().length>0&&(a.empty(),this.notificationItemViews=[],this.pageBegin=0)},renderOnePageItems:function(c){a(c.target).is(".js-dropdown-toggle")||c.stopPropagation();var d=this.pageBegin+this.pageSize,e=b.filter(this.notificationCollection.slice(this.pageBegin,d),function(a){return a.toJSON().isUnread===!0});if(e.length>0){var f=e.map(this.renderItem,this);this.notificationItemViews=b.union(this.notificationItemViews,f),this.$(".js-dropdown-content").append(b.map(f,this.getItemDom,this)),this.pageBegin=this.notificationItemViews.length,this._updateReminder()}},renderItem:function(a,b,c){var d=new cantas.views.NotificationItemView({model:a});return c&&c.add===!0&&(this.$(".js-dropdown-content").prepend(this.getItemDom(d)),this.pageBegin++,this.notificationItemViews.push(d),this._updateReminder()),d},getItemDom:function(a){return a.render().el},_updateReminder:function(){var a=this.notificationCollection.where({isUnread:!0}).length,b=this.$(".reminder");0===a?b.hide():b.show(),b.html(a)},markAllAsRead:function(a){a.stopPropagation(),this.notificationCollection.forEach(function(a){a.patch({isUnread:!1})}),this.pageBegin=0,this._updateReminder(),this.$("ul.js-dropdown-content li.unread").removeClass("unread")},hasRead:function(b){b.stopPropagation(),this.notificationCollection.get(a(b.target).closest("li").prop("id")).patch({isUnread:!1})},setToRead:function(a){this.$("#"+a.id).removeClass("unread"),this._updateReminder()}}),cantas.views.NotificationItemView=c.View.extend({tagName:"li",template:jade.compile(a("#template-notification-item-view").text()),initialize:function(){},render:function(){this.model.get("isUnread")&&this.$el.addClass("unread"),this.$el.prop("id",this.model.id);var a=this.model.toJSON();return a.message=markdown.toHTML(a.message),a.created=cantas.utils.formatDate(a.created),this.$el.html(this.template(a)),this}})}(jQuery,_,Backbone),function(){"use strict";cantas.models.BoardMember=cantas.models.BaseModel.extend({urlRoot:"user"}),cantas.models.BoardMemberCollection=cantas.models.BaseCollection.extend({url:"/boardmemberrelation",model:cantas.models.BoardMember})}(jQuery,_,Backbone),function(a,b,c){"use strict";cantas.views.MemberView=cantas.views.BaseView.extend({tagName:"li",template:b.template("<%= email %><a>×</a>"),render:function(){var a={email:this.model.get("userId").email};this.$el.html(this.template(a)).attr("tabindex",-1);var b=cantas.utils.getCurrentBoardModel().get("creatorId")._id,c=cantas.utils.getCurrentUser(),d=c.id===b;if(d){var e=this.model.get("userId")._id===c.id;e&&this.$el.find("a").remove()}else this.$el.find("a").remove();return this}}),cantas.views.BoardMembersView=c.View.extend({events:{},initialize:function(){this.model.on("add",this.addBoardMember,this)},addBoardMember:function(){}}),cantas.views.BoardMemberEditionView=c.View.extend({}),cantas.views.BoardMembersManageView=c.View.extend({el:"div.invite",events:{"keydown .input-member":"onMemberInputKeyup","keyup .input-member":"onMemberInputKeyup","click ul.toBeInvitedUsers li a":"closeMemberTag","click .invite-member li a":"revokeMembership","keyup .invite-new .invite-display":"deleteMemberTag","keydown .invite-new .invite-display":"focusMemberTag","click ul.toBeInvitedUsers li:not(:has(input))":"selectMemberTag","click .invite-new .invite-display":"focusOnMemberInput","click #btn-invite":"onInviteClick","click .collapse-bar":"toggleInviteMember","click header a":"toggleInviteMember"},initialize:function(){this.cache={},this.memberViews=[],this.collection.on("add",this.showBoardMember,this),a(".invite").on("click",function(b){for(var c=b||window.event,d=c.srcElement||c.target;d&&d!==a(".invite")[0];){if(d.className.indexOf("invite-tip")>-1)return;d=d.parentNode}a(".invite-tip").hide()});this.bConfirmDeleteMember=!0,this.socketInit(),this.showMembersOnlyOnce()},socketInit:function(){var a=this,b=cantas.socket;b.removeAllListeners("user-exists-resp"),b.on("user-exists-resp",function(b){var c=b.data;c.exists||(c.isEmailAddr?a.showValidationMessage(c.username+" is not Cantas user, invite to Cantas?"):-1!==c.username.indexOf("@")&&a.showValidationMessage(c.username+" is not a REDHAT account."),a.markMemberCandidateError(c.username)),a.toggleInviteButton()}),b.removeAllListeners("revoke-membership-resp"),b.on("revoke-membership-resp",function(b){a.revokeMembershipResp(b)})},toggleInviteButton:function(){var b=this.getCandidateMembers().length>0;b?a("#btn-invite").removeAttr("disabled"):a("#btn-invite").attr("disabled","disabled")},focusOnMemberInput:function(){this.$el.find("input.input-member").focus()},showBoardMember:function(a){var b=this.getMembersDisplayContainer(),c=new cantas.views.MemberView({model:a});b.append(c.render().el),this.memberViews.push(c)},makeNewMemberBeCandidate:function(b,c){var d=a.trim(c.val());if(d=d.indexOf(",")>-1?d.slice(0,d.indexOf(",")):d,d.length>0){this.$el.find(".invite-new .tip:visible").length>0&&this.$el.find(".invite-new .tip").hide(),c.val("").attr("size",2),this.$("div.responseData ul").hide();var e=null;return cantas.utils.checkEmail(d)?(a(b.target.parentNode).before('<li tabindex="-1">'+d+"<a>×</a></li>"),e=!0):(this.showValidationMessage(d+" is not a valid email address."),e=!1),e}},getCandidateMembers:function(a){var b=a||{effective:!0},c=null;return c=b.effective?this.$el.find("ul.toBeInvitedUsers li:not(.warning)").not(":has(input)"):this.$el.find("ul.toBeInvitedUsers li").not(":has(input)")},getMemberCandidateName:function(a){return a.firstChild.textContent},showValidationMessage:function(a){var b=this.$el.find(".invite-new .tip").length>0;b?this.$el.find(".invite-new .tip").text(a).show():this.$el.find(".invite-new .invite-display").after('<div class="tip invite-tip">'+a+"</div>").next().css("display","block")},isMemberAlready:function(a){var b=this,c=!1;return this.$el.find(".invite-member li").each(function(d,e){return b.getMemberCandidateName(e)===a?(c=!0,!0):void 0}),c},inputAlready:function(a){var b=this,c=!1,d={effective:!1},e=this.getCandidateMembers(d).slice(0,-1);return e.each(function(d,e){return b.getMemberCandidateName(e)===a?(c=!0,!0):void 0}),c},validateRecentCandidate:function(){var a=this.getCandidateMembers().last()[0],b=this.getMemberCandidateName(a);this.inputAlready(b)?(this.showValidationMessage("The user name '"+b+"' has existed."),this.deleteRedundantMember(b)):this.isMemberAlready(b)?(this.showValidationMessage(b+" is this board's member already."),this.deleteRedundantMember(b)):cantas.socket.emit("user-exists",{username:b})},markMemberCandidateError:function(b){var c=this,d=this.getCandidateMembers();d.each(function(d,e){var f=c.getMemberCandidateName(e)===b;return f?void a(e).addClass("warning"):void 0})},deleteRedundantMember:function(){var a=this.getCandidateMembers({effective:!1});a.last().remove()},onMemberInputKeyup:function(b){var c=this.$el.find(".input-member"),d=this;if(a(".input-member").autocomplete({source:function(b,c){a.ajax({url:"/api/search_member",type:"GET",data:b}).success(function(d){var e=a.ui.autocomplete.escapeRegex(b.term),f=new RegExp("^"+e,"i"),g=a.grep(d,function(a){return f.test(a.email)}),h=a.grep(d,function(a){return!f.test(a.email)}),i=[],j=0,k=0;for(k;20>k;k++)if(g[k])i.push(g[k].email);else{if(!(h[j]&&20>j))break;i.push(h[j].email),j++}c(a.map(i,function(a){return{label:a,value:a}}))})},minLength:1,messages:{noResults:"",results:function(){}},select:function(a,b){return c.val(b.item.value),d.makeNewMemberBeCandidate(a,c)&&d.validateRecentCandidate(),!1},response:function(){var b=d.$("div.invite-new div.invite-display"),c=b.find("div.responseData");0===c.length?a("ul.ui-autocomplete").css({position:"absolute",top:b.height(),left:0}).wrap('<div class="responseData"></div>').parent().appendTo(b):a("ul.ui-autocomplete").appendTo(c)}}),c.val().length>1){var e=a(b.target).outerWidth(!0),f=a(b.target).closest("ul").width();f>e&&c.attr("size",c.val().length)}var g=cantas.KEY_CODES;if(b.which===g.COMMA||b.which===g.SPACE||b.which===g.ENTER){var h=a.trim(c.val());if(0===h.length||0===h.replace(/,/g," ").trim().length)return void c.val("").attr("size",2);this.makeNewMemberBeCandidate(b,c)&&this.validateRecentCandidate()}},closeMemberTag:function(b){a(b.target.parentNode).remove(),this.toggleInviteButton(),this.focusOnMemberInput()},deleteMemberTag:function(b){var c=cantas.KEY_CODES;if(b.which===c.BACKSPACE){var d={};a(document.activeElement).is("li")?a(document.activeElement).next()[0]===this.$el.find(".input-member").parent()[0]?(a(document.activeElement).remove(),d=this.$el.find(".input-member").val(),this.$el.find(".input-member").val("").focus().val(d)):(d=a(document.activeElement),a(document.activeElement).prev().focus(),0===d.prev().length&&this.$el.find(".input-member").focus(),d.remove()):this.$el.find("li input:focus").length>0&&0===this.iCursorPosition&&this.iCursorPosition===this.$el.find(".input-member")[0].selectionStart&&this.$el.find(".input-member").parent().prev().focus()}},focusMemberTag:function(b){var c=cantas.KEY_CODES;b.which===c.BACKSPACE&&(a(document.activeElement).is("li")&&b.preventDefault(),a(document.activeElement).is("input")&&(this.iCursorPosition=this.$el.find(".input-member")[0].selectionStart)),b.which===c.LEFT_ARROW&&(a(document.activeElement).is("li")?a(document.activeElement).prev().focus():this.$el.find("li input:focus").length>0&&""===this.$el.find(".input-member").val()&&this.$el.find(".input-member").prev().focus()),b.which===c.RIGHT_ARROW&&a(document.activeElement).is("li")&&(a(document.activeElement).next().is("li:has(input)")?this.$el.find(".input-member").focus():a(document.activeElement).next().focus())},selectMemberTag:function(a){a.stopPropagation()},getMembersDisplayContainer:function(){var a=this.cache.membersContainer;return void 0===a&&(a=this.$el.find(".invite-member .invite-display ul"),this.cache.membersContainer=a),a},onInviteClick:function(){var a=this,b=this.getCandidateMembers();if(0!==b.length){var c=this.getCurrentBoard().attributes.creatorId,d="object"==typeof c?c._id:c;d!==this.getCurrentUser().id&&b.find("a").remove(),this.getMembersDisplayContainer().append(b);var e=[];b.each(function(b,c){e.push(a.getMemberCandidateName(c))}),this.requestInvitation(e),this.focusOnMemberInput(),this.toggleInviteButton()}},requestInvitation:function(a){var c=cantas.socket;c.once("invite-board-member-resp",function(){});var d=cantas.utils.getCurrentBoardModel(),e={boardId:d.id,boardUrl:b.result(d,"url"),inviter:cantas.user.username,invitees:a};c.emit("invite-board-member",e)},toggleInviteMember:function(){1===a(".activity:visible").length&&a(".activity").hide(),this.$el.toggle("slide",{direction:"right"},"fast")},remove:function(){return b.forEach(this.memberViews,function(a){a.close()}),this.collection.dispose(),this.undelegateEvents(),this.stopListening(),this},showMembersOnlyOnce:function(){void 0===this.membersLoadedAndShown&&(this.collection.fetch({data:{boardId:cantas.utils.getCurrentBoardModel().id,$or:[{status:"available"},{status:"inviting"}]}}),this.membersLoadedAndShown=!0)},getCurrentBoard:function(){return cantas.utils.getCurrentBoardView().model},getCurrentUser:function(){return cantas.user},confirmDeleteMember:function(b){b.stopPropagation(),a("body").click();var c=this;cantas.utils.getCurrentBoardView().confirmDialogView.render({operationType:"delete",operationItem:"member",confirmInfo:"Are you sure to delete this member?",captionYes:"Delete",yesCallback:function(){c.emitMembership({deleteObj:b.target.parentNode}),a("#js-cb-noask:checked").length>0&&(c.bConfirmDeleteMember=!1),a("#confirm-dialog").hide()},captionNo:"Cancel",noCallback:function(){a("#confirm-dialog").hide()},pageX:b.pageX,pageY:b.pageY})},revokeMembership:function(b){cantas.appRouter.currentView.confirmDialogView||(cantas.appRouter.currentView.confirmDialogView=new cantas.views.ConfirmDialogView),this.bConfirmDeleteMember?(a(b.target.parentNode).focus(),this.confirmDeleteMember(b)):this.emitMembership({deleteObj:b.target.parentNode})},emitMembership:function(a){var b=cantas.socket,c=this.getMemberCandidateName(a.deleteObj);b.emit("revoke-membership",{sender:cantas.utils.getCurrentUser().id,username:c,boardId:cantas.utils.getCurrentBoardModel().id})},revokeMembershipResp:function(b){if(0===b.ok){var c=this.$el.find(".invite-member li"),d=b.data.username;if(c.each(function(b,c){var e=c.firstChild.textContent.split("@")[0];return e===d?(a(c).remove(),!0):void 0}),b.data.updated.userId._id===cantas.utils.getCurrentUser().id&&b.data.updated.boardId===cantas.utils.getCurrentBoardId()){var e=cantas.utils.getCurrentBoardModel().attributes.isPublic,f=a(".force-alert");e?(f.find("p").text("Your membership is revoked. You are not a member of this board from now."),f.find("a").attr("href",window.location).text("Please reload this board!"),f.modal({backdrop:"static"})):(f.find("p").text("Your membership is revoked from this private board."),f.find("a").attr("href","/boards/mine").text("Please go to home page!"),f.modal({backdrop:"static"}))}}else alert(b.data)}})}(jQuery,_,Backbone),function(a,b){"use strict";var c=cantas.models.BaseModel,d=cantas.models.BaseCollection;cantas.models.Label=c.extend({urlRoot:"label"}),cantas.models.LabelCollection=d.extend({model:cantas.models.Label,url:"/label",initialize:function(){b.bindAll(this,"serverCreate"),this.noIoBind||this.ioBind("create",this.socket,this.serverCreate,this)}}),cantas.models.CardLabelRelation=c.extend({urlRoot:"cardlabelrelation"}),cantas.models.CardLabelRelationCollection=d.extend({model:cantas.models.CardLabelRelation,url:"cardlabelrelation",initialize:function(){},comparator:function(a){return a.get("cardId").order}})}(jQuery,_,Backbone),function(){"use strict";cantas.models.SyncConfig=cantas.models.BaseModel.extend({idAttribute:"_id",noIoBind:!1,socket:cantas.socket,url:function(){return"/syncconfig"+(this.id?"/"+this.id:"")},initialize:function(){this.noIoBind||(this.ioBind("update",this.serverChange,this),this.ioBind("delete",this.serverDelete,this))},serverChange:function(a){this.set(a)},serverDelete:function(){"object"==typeof this.collection?this.collection.remove(this):this.trigger("remove",this)},modelCleanup:function(){return this.ioUnbindAll(),this}}),cantas.models.SyncConfigCollection=cantas.models.BaseCollection.extend({model:cantas.models.SyncConfig,socket:cantas.socket,url:"/syncconfig",initialize:function(){this.socket.removeAllListeners("/syncconfig:create"),this.socket.on("/syncconfig:create",this.serverCreate,this)},serverCreate:function(a){if(a){var b=cantas.utils.getCurrentBoardModel();b&&b.syncConfigCollection.add(a)
}},collectionCleanup:function(){return this.ioUnbindAll(),this.each(function(a){a.modelCleanup()}),this},comparator:function(a,b){return a.get("createdOn")>b.get("createdOn")?1:a.get("createdOn")<b.get("createdOn")?-1:0}})}(jQuery,_,Backbone),function(a,b,c){"use strict";cantas.views.ImportBugzillaView=c.View.extend({el:"div.window-overlay",template:jade.compile(a("#template-import-bugzilla-view").text()),initialize:function(){this.boardId=this.model.id,this.isConfirmDeleteSyncConfig=!0,this.listenTo(this.model.syncConfigCollection,"add",this.renderSyncConfigItem),this.model.syncConfigCollection.fetch({data:{boardId:this.model.id}})},events:{"click .js-add-mapping":"showAddMappingView","click .js-sync-all":"onMappingSyncAll","hidden.bs.modal":"closeImportBugzillaWindow"},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.$el.modal(),this.renderAllSyncConfigItems(),this},renderSyncConfigItem:function(a){var b=new cantas.views.SyncConfigItemView({model:a,parentView:this});this.$("div.mapping-add").after(b.render().el);var c=this.$(".js-sync-all");c.prop("disabled")&&c.prop("disabled",!1)},renderAllSyncConfigItems:function(){var a=this;0===this.model.syncConfigCollection.length?this.$(".js-sync-all").prop("disabled",!0):this.model.syncConfigCollection.each(function(b){a.renderSyncConfigItem(b)})},showAddMappingView:function(){void 0===this.syncConfigItemAddView?this.syncConfigItemAddView=new cantas.views.SyncConfigItemAddView({model:this.model,parentView:this}):this.syncConfigItemAddView.initialize(),this.$el.find("div.mapping-edit button.js-syncconfig-cancel").click(),this.syncConfigItemAddView.render(),this.$el.find("div.mapping-add").show().append(this.syncConfigItemAddView.$el),this.syncConfigItemAddView.$el.show(),this.syncConfigItemAddView.$el.find("input.js-query-url").select()},onMappingSyncAll:function(b){a(b.target).prop("disabled",!0),a(".js-mapping-sync").trigger("click")},closeImportBugzillaWindow:function(){this.syncConfigItemAddView&&this.syncConfigItemAddView.remove(),this.undelegateEvents(),this.stopListening(),this.$el.empty()}}),cantas.views.SyncConfigItemView=cantas.views.BaseView.extend({className:"mapping-list",template:jade.compile(a("#template-syncconfig-item-view").text()),events:{"click .js-is-active":"switchActiveStatus","click .js-mapping-sync":"onMappingSync","click .js-mapping-stopsync":"onMappingStopSync","click .js-queryurl-wrapper,.js-listname-wrapper":"openEditMode","click .js-syncconfig-delete":"onDeleteSyncConfigClick"},initialize:function(){b.bindAll(this,"render","socketInit"),this.socketInit(),this.parentView=this.options.parentView,this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"remove",this.onModelRemove)},render:function(){var a=this.model.toJSON();return a.listName=a.listId.title,a.isBoardMember=window.cantas.isBoardMember,this.$el.html(this.template(a)),this.model.get("isActive")?this.$el.removeClass("mapping-disabled"):this.$el.addClass("mapping-disabled"),window.cantas.isBoardMember||this.undelegateEvents(),this},onModelRemove:function(){1===this.parentView.$(".mapping-list").not(".mapping-add").length&&this.parentView.$(".js-sync-all").prop("disabled",!0),this.close()},confirmDeleteSyncConfig:function(b){b.stopPropagation(),a("body").click();var c=this;cantas.utils.getCurrentBoardView().confirmDialogView.render({operationType:"delete",operationItem:"mapping",confirmInfo:"Are you sure to delete this mapping?",captionYes:"Delete",yesCallback:function(){c.removeSyncConfig(),a("#js-cb-noask:checked").length>0&&(c.parentView.isConfirmDeleteSyncConfig=!1),a("#confirm-dialog").hide()},captionNo:"Cancel",noCallback:function(){a("#confirm-dialog").hide()},pageX:b.pageX-285,pageY:b.pageY})},removeSyncConfig:function(){this.$el.fadeOut(),this.model.destroy()},onDeleteSyncConfigClick:function(b){if(null!==this.model){cantas.utils.getCurrentBoardView().confirmDialogView||(cantas.utils.getCurrentBoardView().confirmDialogView=new cantas.views.ConfirmDialogView);var c=this.parentView;c.isConfirmDeleteSyncConfig?(a(b.target.parentNode).focus(),this.confirmDeleteSyncConfig(b),a("div.window-module").on("scroll",function(){a("body").click()})):this.removeSyncConfig()}},socketInit:function(){var a=cantas.socket,b=this,c=b.model.id;a.on("sync-bugs:resp:"+c,function(a){var c=a.msg;a.status?(b.$(".js-sync-status").removeClass("alert-success").addClass("alert-danger"),c.indexOf("Stoped")>-1&&b.$(".js-mapping-stopsync").text("Sync").removeClass("js-mapping-stopsync btn-danger").addClass("js-mapping-sync btn-primary")):(b.$(".js-sync-status").removeClass("alert-danger").addClass("alert-success"),b.$(".js-mapping-stopsync").text("Sync").removeClass("js-mapping-stopsync btn-danger").addClass("js-mapping-sync btn-primary")),b.$(".js-sync-status").html(c),b.delegateEvents(),b.$(".js-mapping-sync").prop("disabled",!1),0===b.parentView.$(".js-mapping-stopsync").length&&b.parentView.$(".js-sync-all").prop("disabled",!1)})},switchActiveStatus:function(){this.model.patch({isActive:!this.model.get("isActive")})},onMappingSync:function(b){var c={syncId:this.model.id};this.socketInit(),cantas.socket.emit("sync-bugs:req",c),a(b.target).text("Stop").removeClass("js-mapping-sync btn-primary").addClass("js-mapping-stopsync btn-danger").prop("disabled",!1),this.$(".js-sync-status").removeClass("alert-danger").addClass("alert-success").html("loading...."),this.undelegateEvents(),this.delegateEvents({"click .js-mapping-stopsync":"onMappingStopSync"})},onMappingStopSync:function(b){cantas.socket.emit("sync-bugs:stopSync",{syncId:this.model.id}),a(b.target).prop("disabled",!0)},openEditMode:function(b){this.parentView.$("div.mapping-add button.js-syncconfig-cancel").click(),this.parentView.$("div.mapping-edit button.js-syncconfig-cancel").click(),this.$el.find("div.row-fluid, a.mapping-delete").addClass("hide");var c=new cantas.views.SyncConfigItemEditView({parentView:this});this.$el.find("div.row-fluid").after(c.render().$el),c.$el.find("input.js-query-url").trigger("change"),a(b.target).is(".js-queryurl-wrapper")&&c.$el.find(".js-query-input").select()}}),cantas.views.SyncConfigItemAddView=cantas.views.BaseView.extend({className:"js-add-mappping",template:jade.compile(a("#template-syncconfig-item-input-view").text()),events:{"click .js-specify-list":"switchSpecifyListMode","click .js-syncconfig-add":"addSyncConfig","click .js-syncconfig-cancel":"hideAddModeView"},initialize:function(){this.parentView=this.options.parentView,this.model.listCollection.on("add",this.render,this),this.model.listCollection.on("remove",this.render,this),b.bindAll(this,"render","socketInit"),this.socketInit(),this.isNewList=!1},render:function(){var a={};return a.lists=[],this.model.listCollection.each(function(b){b.toJSON().isArchived||a.lists.push({id:b.toJSON()._id,name:b.toJSON().title})}),this.$el.html(this.template(a)),this},socketInit:function(){var a=cantas.socket,b=this;a.removeAllListeners("sync-bugs:checked-queryurl"),a.on("sync-bugs:checked-queryurl",function(a){var c=a.msg;a.status?(b.$el.find("div.js-alert").removeClass("alert-success").addClass("alert-danger"),b.$el.find("div.js-alert").html(c)):(b.$el.find("div.js-alert").removeClass("alert-danger").addClass("alert-success"),c="Query"+a.msg+" Bugs",b.$el.find("div.js-alert").html(c),b.$el.find("input.js-query-url").hasClass("js-create-mapping")?(b.saveSyncConfig(),b.$el.find("input.js-query-url").removeClass("js-create-mapping")):b.$el.find("input.js-query-url").hasClass("js-update-mapping")&&(b.saveEditedSyncConfig(),b.$el.find("input.js-query-url").removeClass("js-update-mapping")))})},checkQueryurl:function(){var a=this.$("input.js-query-url").val();if(a){var b={boardId:this.boardId,queryUrl:a};cantas.socket.emit("sync-bugs:queryurl",b),this.$el.find("div.js-alert").removeClass("hide"),this.$el.find("div.js-alert").removeClass("alert-danger").addClass("alert-success").html("loading..."),this.$el.find("div.js-alert").addClass("js-query-url-active")}else{var c="Url can not be null";this.$el.find("div.js-alert").removeClass("hide"),this.$el.find("div.js-alert").removeClass("alert-success").addClass("alert-danger").html(c)}},switchSpecifyListMode:function(b){var c=this.$("select.js-list-name"),d=this.$("input.js-list-name");this.isNewList?(a(b.target).text("New List"),d.hide(),c.show(),this.isNewList=!1):(a(b.target).text("Choose a existing List"),c.hide(),d.show().select(),this.isNewList=!0)},isValidListName:function(){var a=this,b=!1;if(a.isNewList){var c=a.$("input.js-list-name").val();c&&(b=!0)}else{var d=a.$("select.js-list-name").find("option:selected").val();d&&(b=!0)}return b},saveSyncConfig:function(){var b=this.$(".js-query-url").val(),c={boardId:this.model.id,queryUrl:b,queryType:"bugzilla",creatorId:cantas.user.id};if(this.isNewList){var d=this.$("input.js-list-name").val();c.listId="0",c.listName=a.trim(d),c.listOrder=this.model.listCollection.last().toJSON().order}else{var e=this.$("select.js-list-name").find("option:selected").val();c.listId=e}var f=new cantas.models.SyncConfig(c);f.save(),this.hideAddModeView()},addSyncConfig:function(){return this.isValidListName()?(this.checkQueryurl(),void this.$el.find("input.js-query-url").addClass("js-create-mapping")):!1},hideAddModeView:function(){this.$el.hide(),this.parentView.$el.find("div.mapping-add").hide()}}),cantas.views.SyncConfigItemEditView=cantas.views.SyncConfigItemAddView.extend({className:"row-fluid mapping-edit",template:jade.compile(a("#template-syncconfig-item-edit-view").text()),events:{"click .js-specify-list":"switchSpecifyListMode","click .js-syncconfig-save":"editSyncConfig","click .js-syncconfig-cancel":"closeEditMode"},initialize:function(){this.parentView=this.options.parentView,this.listCollection=cantas.utils.getCurrentBoardModel().listCollection,this.listCollection.on("add",this.render,this),this.listCollection.on("remove",this.render,this),b.bindAll(this,"render","socketInit"),this.socketInit(),this.isNewList=!1},render:function(){var a=this.parentView.model.toJSON();return a.lists=[],this.listCollection.each(function(b){b.get("isArchived")||a.lists.push({id:b.get("_id"),name:b.get("title")})}),this.$el.html(this.template(a)),this},editSyncConfig:function(a){return a.stopPropagation(),this.isValidListName()?(this.checkQueryurl(),void this.$el.find("input.js-query-url").addClass("js-update-mapping")):!1},saveEditedSyncConfig:function(){var b=a.trim(this.$("input.js-query-url").val()),c=this.isNewList?"0":this.$("select.js-list-name option:selected").val(),d={queryUrl:b,listId:c},e=this.parentView.model.changedAttributes(d);e&&("0"===d.listId&&(e.listName=a.trim(this.$("input.js-list-name").val()),e.listOrder=this.listCollection.last().toJSON().order,e.boardId=this.parentView.model.get("boardId"),e.creatorId=cantas.utils.getCurrentUser().id),this.parentView.model.patch(e,{silent:!0})),this.closeEditMode()},closeEditMode:function(){this.parentView.$(".row-fluid:not(.mapping-edit), a.mapping-delete").removeClass("hide"),this.remove()}})}(jQuery,_,Backbone),function(a,b,c){"use strict";cantas.models.Board=cantas.models.BaseModel.extend({idAttribute:"_id",noIoBind:!1,socket:cantas.socket,url:function(){return"/board"+(this.id?"/"+this.id:"")},initialize:function(){this.listCollection=new cantas.models.ListCollection,this.syncConfigCollection=new cantas.models.SyncConfigCollection,this.noIoBind||(this.ioBind("update",this.serverChange,this),this.ioBind("delete",this.serverDelete,this))},dispose:function(){return this.off(),this.listCollection.off(),this.syncConfigCollection.off(),this.noIoBind||(this.ioUnbindAll(),this.listCollection.dispose(),this.syncConfigCollection.dispose()),this},validate:function(a){var b=a.title;if(void 0===b)return"Board does not contain a title.";if(/^\s+$/.test(b))return"It's recommended that you enter a significant board's title.";var c=a.description;return void 0===c?"Board does not contain a description.":/^\s+$/.test(c)?"It's recommended that you enter a significant board's description.":void 0},serverChange:function(a){this.set(a)},serverDelete:function(){"object"==typeof this.collection?this.collection.remove(this):this.trigger("remove",this)},modelCleanup:function(){return this.ioUnbindAll(),this}}),cantas.models.BoardCollection=c.Collection.extend({model:cantas.models.Board,socket:cantas.socket,url:"/board",initialize:function(){this.on("collectionCleanup",this.collectionCleanup,this),this.bindCreateEvent(this.socket)},bindCreateEvent:function(a){a.removeAllListeners("/board:create"),a.on("/board:create",this.serverCreate,this)},fetchTotal:function(c,d){var e=this.socket||window.socket,f=a.Deferred();return e.emit("board:read",b.extend({$count:{$or:[{isPublic:!0},{creatorId:cantas.user.id}],title:{$regex:c,$options:"gi"}}},d||{}),function(a,b){return a?f.reject():void f.resolve(b||0)}),f.promise()},serverCreate:function(a){if(a){var b=cantas.boards.get(a._id);"undefined"==typeof b?cantas.boards.add(a):b.set(a)}},collectionCleanup:function(){return this.ioUnbindAll(),this.each(function(a){a.modelCleanup()}),this},status:function(){return this.filter(function(a){return a.get("status")})}})}(jQuery,_,Backbone),function(b,c,d){"use strict";window.cantas.isBoardMember=!1;var e=d.View.extend({el:"#board-header",tagName:"header",id:"board-header",template:jade.compile(b("#template-board-title-view").text()),events:{"click .js-edit-board-title":"edit","click #board-title-save":"saveButtonClicked","click #board-title-input":"boardTitleInputClicked","keypress #board-title-input":"boardTitleInputKeypressed","click .js-toggle-board-menu":"toggleBoardMenu"},initialize:function(){this.model.on("invalid",function(a,b){alert(b)}),this.model.on("change:title",this.titleChangedFromOthers),b("body").on("click",function(a){for(var c=a||window.event,d=c.srcElement||c.target;d&&d!==b("body")[0];){if(d.className.indexOf("board-menu")>-1)return;d=d.parentNode}b(".board-menu").hide()})},remove:function(){return this.undelegateEvents(),this.stopListening(),this},getBoardTitle:function(){return b("#board-title-input").val()},titleChangedFromOthers:function(a,c){var d=b(".js-edit-board-title");d.html(cantas.utils.safeString(c)),d.attr("title",d.text())},edit:function(a){a.stopPropagation();var c=b("div.js-edit-board-title");c.html(this.template()).removeAttr("title").removeClass("js-edit-board-title board-title").addClass("board-title-edit"),b("#board-title-input").val(this.model.get("title")).focus().select(),this.attributes.expandedViewChain=cantas.utils.rememberMe(this,this.attributes.expandedViewChain)},saveTitle:function(){var a=this.getBoardTitle().trim();if(0===a.length)alert("Please enter a board title.");else{var b=this.model.get("title"),c=this.model.set({title:a},{validate:!0});c&&this.model.hasChanged("title")&&this.model.patch({title:this.model.get("title"),original:{title:b}})}return!0},boardTitleInputClicked:function(a){a.stopPropagation()},saveButtonClicked:function(a){this.saveTitle()||a.stopPropagation()},boardTitleInputKeypressed:function(a){13===a.which&&this.saveTitle()&&b("body").trigger("click")},collapse:function(){{var a=b("#board-edit-title").parent("div");a.html()}a.html(b("#board-title-placeholder").html()).addClass("js-edit-board-title board-title").removeClass("board-title-edit").html(cantas.utils.safeString(this.model.get("title"))).attr("title",a.text())},toggleBoardMenu:function(a){b(".board-menu").css("left",b(a.target).position().left+20).toggle()}}),f=d.View.extend({tagName:"li",className:"",template:jade.compile(b("#template-archived-items-view").text()),section:"lists",initialize:function(a){c.bindAll(this,"render"),this.section=a.section,this.highlighted=a.highlighted},events:{"click .js-reopen":"reopenArchivedList","click .js-cards-reopen":"reopenArchivedCard"},render:function(){return this.$el.html(this.template({item:this.model,section:this.section,highlighted:this.highlighted})),this},reopenArchivedList:function(a){a.preventDefault(),a.stopPropagation();var d=b(a.target).data("listid"),e=new cantas.models.List({_id:d}),f=cantas.utils.getCurrentBoardModel().listCollection.pluck("order");f.sort(function(a,b){return a-b});var g="undefined"==typeof c.last(f)?-1:c.last(f),h=g+65536;e.fetch({success:function(a){a.patch({isArchived:!1,order:h,original:{isArchived:!0}},{silent:!0})}}),this.remove()},reopenArchivedCard:function(a){var d=b(a.target).data("cardid"),e=new cantas.models.Card({_id:d});e.fetch({success:function(a){var d=cantas.utils.getCurrentBoardView(),e=c.map(d.listViewCollection,function(a){return a.model.id}),f=c.indexOf(e,a.get("listId"));if(-1===f){var g="/api/archived/getorders/"+a.get("listId");b.ajax({url:g}).success(function(b){var d=c.pluck(b,"order");d.sort(function(a,b){return a-b});var e=null;e="undefined"==typeof c.last(d)?-1:c.last(d);var f=e+65536;a.patch({isArchived:!1,order:f,original:{isArchived:!0}},{silent:!0})}).fail(function(){return cantas.utils.renderTimeoutBox(),!1})}else{var h=cantas.utils.getCurrentBoardView().listViewCollection[f],i=h.model.cardCollection.pluck("order");i.sort(function(a,b){return a-b});var j=null;j="undefined"==typeof c.last(i)?-1:c.last(i);var k=j+65536;a.patch({isArchived:!1,order:k,original:{isArchived:!0}},{silent:!0})}}}),this.remove()},remove:function(){this.undelegateEvents(),this.stopListening(),this.$el.remove()}}),g=d.View.extend({el:"#board-description",tagName:"div",className:"modal board-description hide",events:{"click #save-board-edit":"saveClicked","click #cancel-board-edit":"collapse","click #close-board-edit":"collapse"},initialize:function(){b("a.board-info").on("click",this,this.toggleInfoEdition),this.model.on("invalid",function(a,b){alert(b)}),b("#board-description").on("click",function(a){a.stopPropagation()}),this.model.on("change:description",this.descriptionChangedFromOthers)},remove:function(){return this.undelegateEvents(),this.stopListening(),this},toggleInfoEdition:function(a){a.stopPropagation();var c=a.data;b("div#board-description").hasClass("hide")?(b(".board-menu").hide(),b(".list-menu,.js-list-setting").hide(),b(".card-menu,.card-setting").hide(),c.showInfoEditionDialog()):c.collapse()},showInfoEditionDialog:function(){b("div#board-description").removeClass("hide"),b("#board-description-text").val(this.model.get("description")),this.attributes.expandedViewChain=cantas.utils.rememberMe(this,this.attributes.expandedViewChain)},descriptionChangedFromOthers:function(a,c){b("#board-description-text").text(c)},saveClicked:function(){var a=b("#board-description-text").val().trim(),c=this.model.get("description"),d=this.model.set({description:a},{validate:!0});d!==!1&&this.model.hasChanged("description")&&this.model.patch({description:this.model.get("description"),original:{description:c}}),b("body").trigger("click")},collapse:function(){b("div#board-description").addClass("hide"),this.model.hasChanged("description")&&b("textarea#board-description-text").val(this.model.get("description")),this.attributes.expandedViewChain=cantas.utils.forgetMe(this,this.attributes.expandedViewChain)}}),h=d.View.extend({el:"div#list-new",events:{"click .js-create-new-list":"saveNewList","keypress #list-title":"keyPressed"},initialize:function(){this.title="Untitled List"},render:function(){return b("div.board-menu").hide(),this.$el.modal(),this.$el.find("#list-title").val(this.title).select(),this},remove:function(){return this.undelegateEvents(),this.stopListening(),this.$el.hide(),this},saveNewList:function(a){a.stopPropagation();var c=b("#list-title").val().trim();if(c){var d=new cantas.models.List({title:c,boardId:this.model.id,creatorId:cantas.user.id,order:this.calcPos()});d.save(),this.$el.modal("hide")}else b("#list-title").select()},keyPressed:function(a){13===a.which&&this.saveNewList(a)},calcPos:function(){var a=-1,b=this.model.listCollection,d=b.length;if(0===d&&(a+=65536),d>0){var e=c.last(b.pluck("order"));a=e+65536}return a}}),i=d.View.extend({el:"div.window-overlay",template:jade.compile(b("#template-archived-view").text()),archivedItemViews:[],initialize:function(a){c.bindAll(this,"render"),this.section=a&&a.section?a.section:"lists",this.highlighted=a&&a.highlighted?a.highlighted:null},events:{"click .js-switch-section":"switchSections","hidden.bs.modal":"closeArchivedWindow"},render:function(){return this.$el.html(this.template({section:this._toTitleCase(this.section)})),this.$el.find("."+this.section+"-tab").addClass("active"),this.$el.modal(),this._renderArchivedItems(this.el),this},switchSections:function(){return this.section="cards"===this.section?"lists":"cards",this.render()},_toTitleCase:function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()},_renderArchivedItems:function(a){var d=this,e=b(a).find("ul.js-archive-items"),g="/api/archived/cards/"+cantas.utils.getCurrentBoardModel().id,h="/api/archived/lists/"+cantas.utils.getCurrentBoardModel().id,i="cards"===d.section?g:h,j=this.archivedItemViews;b.ajax({url:i,success:function(a){e.parents("div.modal-body").find("p").hide(),c.each(a,function(a){var b=new f({model:a,section:d.section,highlighted:d.highlighted});e.append(b.render().el),j.push(b)})},error:function(){return cantas.utils.renderTimeoutBox(),!1}})},closeArchivedWindow:function(){var a=this.archivedItemViews;c.each(a,function(b){b.remove(),a.pop(b)}),this.undelegateEvents(),this.stopListening(),this.$el.empty()}}),j=d.View.extend({el:"div#import-trello-dialog",events:{"click #import-trello-complete":"reloadBoard"},initialize:function(){},render:function(){return this.$el.modal({keyboard:!1}),this.$("#import-trello-processing").children().show(),this},remove:function(){return this.undelegateEvents(),this.stopListening(),this.$el.hide(),this},reloadBoard:function(a){a.stopPropagation();var b=this.$("#import-trello-message").text();b.indexOf("completed")>-1?window.location.reload():b.indexOf("Error:")>-1&&-1===b.indexOf("check file content")&&window.location.reload(),this.$el.modal("hide")}});cantas.views.BoardView=d.View.extend({el:".content",template:jade.compile(b("#template-board-view").text()),events:{updatesort:"updateSort","click .js-archived-items":"openArchivedItems","click .js-import-bugzilla":"openImportBugzillaWindow","click .js-import-trello":"importTrelloJSON","click .js-add-list":"addList","dblclick .board-content":"addList","click .js-select-private":"toggleVisibility","click .js-toggleInvite":"toggleInviteMember","click .board-side-scroll a":"scrollBoardContent","mousedown .board-side-scroll a":"startScrollBoardContent","mouseup .board-side-scroll a":"stopScrollBoardContent","click .js-close-board":"closeBoardClicked","click .js-show-configuration":"onShowConfigurationClick"},initialize:function(a){window.cantas.isBoardMember=a.isMember,this.listViewCollection=[],this.visitors=a.visitors,this.state=a.state,this.model.listCollection.fetch({data:{boardId:this.model.id},reset:!0}),this.model.listCollection.on("add",this.addOne,this),this.model.listCollection.on("reset",this.addAll,this),this.model.on("change:isPublic",this.resetVisibility,this),this.model.on("change:isClosed",this.onBoardClosed,this),this.memberCollection=new cantas.models.BoardMemberCollection,this.activityCollection=new cantas.models.ActivityCollection,b(window).bind("resize",c.bind(this.resize,this)),b("body").on("click",this,this.bodyClicked),this._expandedViewChain=[],this.timers=[],this.timer_scrollBoard=0,this.flag_continueScrollBoard=!1,this.timer_continueScrollBoard=0},loadState:function(){if(this.state&&this.state.view){var a=this.state.view.split("."),b=a[0];return"archived"===b?new i({section:a[1],highlighted:this.state.highlighted}).render():void 0}},onShowConfigurationClick:function(){var a=new cantas.views.ConfigView({model:this.model});a.show()},openArchivedItems:function(a){a.preventDefault(),a.stopPropagation(),b("div.board-menu").hide();var c=new i;c.render()},openImportBugzillaWindow:function(a){a.preventDefault(),a.stopPropagation(),b("div.board-menu").hide();var c=new cantas.views.ImportBugzillaView({model:this.model});c.render()},importTrelloJSON:function(a){a.preventDefault(),a.stopPropagation(),b("#import-trello").click(),b("div.board-menu").hide()},addList:function(a){a.preventDefault(),this.addListView.render()},close:function(){return this.addListView.remove(),this.boardTitleView.remove(),this.boardDescriptionView.remove(),this.boardMembersManageView.collection.dispose(),this.boardMembersManageView.remove(),this.boardActiveUserView.collection.dispose(),this.boardActiveUserView.remove(),this.activityView.collection.dispose(),this.activityView.remove(),this.listViewCollection.forEach(function(a){a.remove()}),this.model.dispose(),this.$el.empty(),this.undelegateEvents(),this.stopListening(),this},resize:function(){this.$el.find(".list-content").css("max-height",b("#board").height()-90)},render:function(){if("undefined"==typeof this.model)return!1;this.$el.html(this.template(this.model.toJSON())),cantas.setTitle("Board|"+this.model.get("title"));var a=this.model.get("isPublic");a||this.$el.find("a.js-select-private").addClass("active").attr("title","Set to public");var c=this;this.boardTitleView=new e({model:this.model,attributes:{expandedViewChain:this._expandedViewChain}}),this.boardDescriptionView=new g({model:this.model,attributes:{expandedViewChain:this._expandedViewChain}}),this.addListView=new h({model:this.model,attributes:{expandedViewChain:this._expandedViewChain}}),this.importTrelloDialogView=new j,this.activityView=new cantas.views.ActivityCollectionView({collection:this.activityCollection}),this.boardMembersManageView=new cantas.views.BoardMembersManageView({collection:this.memberCollection});var d=this.importTrelloDialogView.$("#import-trello-message"),f=this.importTrelloDialogView.$("#import-trello-complete"),i=this.importTrelloDialogView.$("#import-trello-processing");b("#import-trello").fileupload({autoUpload:!0,url:"/import/"+this.model.id,acceptFileTypes:/(\.|\/)(json)$/i,maxFileSize:1e7,minFileSize:1,dataType:"json"}).on("fileuploadprocessalways",function(a,b){c.importTrelloDialogView.render();var e=b.files[0];e.error&&(d.text("Hint: "+e.error),i.hide(),f.attr("disabled",!1).text("Close"))}).on("fileuploaddone",function(a,b){if(b.result.user_error)throw d.text("Error: "+b.result.user_error),i.hide(),f.attr("disabled",!1).text("Close"),new Error(b.result.maintainer_error);cantas.socket.emit("import-trello-complete",{boardId:c.model.id}),d.text(b.result.success),i.hide(),f.attr("disabled",!1).text("Completed")}).on("fileuploadfail",function(){d.text("Error: Importing the json file from Trello failed"),i.hide(),f.attr("disabled",!1).text("Close")}).on("fileuploadsubmit",function(a,b){return 0===b.files[0].size?(d.text("Hint: Importing the json file from Trello failed"),i.hide(),!1):void 0}),this.boardActiveUserView=new cantas.views.BoardActiveUserCollectionView({collection:this.visitors,el:"#sb_memberlist",boardId:this.model.id}),this.boardActiveUserView.render(),this.buildScrollbar(b("#sb_memberlist")),b("#sb_memberlist .scroll-vbar-wrap").hide(),b("#sb_memberlist").hover(function(){b(".scroll-vbar-wrap").show()},function(){b(".scroll-vbar-wrap").hide()}),window.cantas.isBoardMember||this.disableEvents();var k=this.getCurrentUserRole();return"admin"!==k&&this.$el.find(".js-show-configuration").hide(),this.loadState(),this},getCurrentUserRole:function(){var a=null,b=cantas.utils.getCurrentUser();return this.visitors.each(function(c){c.attributes._id===b.id&&(a=c.attributes.role.name)}),a},disableEvents:function(){this.$el.find("button.js-add-list").hide(),this.$el.find("a.js-select-private").hide(),this.$el.find("a.js-toggleInvite").hide(),this.$el.find("a.js-toggle-board-menu").hide(),this.$el.find("a.board-info").hide(),this.$el.undelegate(".board-content","dblclick"),this.boardTitleView.undelegateEvents()},addAll:function(){this.listViewCollection=this.model.listCollection.map(this.addOne,this),this.$("#board").append(c.map(this.listViewCollection,this.getListDom,this)),a.refreshListSortable(),this.switchScrollButton(),window.cantas.isBoardMember||b(".board").sortable("disable")},addOne:function(c,d,e){var f=new cantas.views.ListView({model:c,attributes:{expandedViewChain:this._expandedViewChain}});if(!e||e.add!==!0)return f;if(this.listViewCollection.push(f),this.$("#board").append(f.render().el),a.refreshCardSortable(),b("#board").find(".list-panel:last").addClass("list-panel-highlight"),setTimeout(function(){b("#board").find(".list-panel").filter(".list-panel-highlight").removeClass("list-panel-highlight")},10),void 0!==c.attributes.creatorId&&c.attributes.creatorId===cantas.user.id){var g=this;b("#board").animate({scrollLeft:b("#board")[0].scrollWidth},1e3,function(){g.switchScrollButton()})}},getListDom:function(a){return a.model.get("isArchived")===!1?a.render().el:null},updateSort:function(b,c,d,e){var f=Number(d),g=Number(e),h=this.model.listCollection,i=h.length,j=-1,k=0,l=0;if(0===f){var m=h.at(f).get("order");j=(m-1)/2}if(f>g&&f>0&&i-1>f&&(k=h.at(f).get("order"),l=h.at(f+1).get("order"),j=(k+l)/2),g>f&&f>0&&i-1>f&&(k=h.at(f-1).get("order"),l=h.at(f).get("order"),j=(k+l)/2),f===i-1){var n=h.at(i-1).get("order");j=n+65536}c.set({order:j},{silent:!0}),c.patch({order:j},{validate:!1}),h.add(c,{merge:!0,silent:!0}),h.sort({silent:!0}),this.model.listCollection=h,a.refreshListSortable(),a.refreshCardSortable()},collapsePreviousEdit:function(){var a=this._expandedViewChain.pop();void 0!==a&&a.collapse()},bodyClicked:function(a){a.data.collapsePreviousEdit()},toggleVisibility:function(a){a.preventDefault(),a.stopPropagation(),b(a.target).hasClass("active")?b(a.target).removeClass("active").attr("title","Set to private"):b(a.target).addClass("active").attr("title","Set to public");var c=this.model.get("isPublic")===!0?!1:!0,d=this.model.get("isPublic");this.model.patch({isPublic:c,original:{isPublic:d}},{silent:!0,validate:!0})},resetVisibility:function(){var a=this.model.get("isPublic");a?this.$el.find("a.js-select-private").removeClass("active").attr("title","Set to private"):this.$el.find("a.js-select-private").addClass("active").attr("title","Set to public")},toggleInviteMember:function(){1===b(".activity:visible").length&&b(".activity").hide(),1===this.$el.find(".invite:visible").length?this.$el.find(".invite").hide("slide",{direction:"right"},"fast"):(this.$el.find(".invite").show("slide",{direction:"right"},"fast"),this.$el.find(".invite-new .input-member").focus())},scrollBoardContent:function(a){this.flag_continueScrollBoard=!1,clearInterval(this.timer_continueScrollBoard);var c=b(a.target).parent().is(".js-board-side-scroll-left")?-278:278,d=this;b("#board").stop().animate({scrollLeft:b("#board").scrollLeft()+c},300,function(){d.switchScrollButton()})},switchScrollButton:function(){b("#board")[0].scrollWidth-b("#board").innerWidth()>0?0===b("#board").scrollLeft()?(this.$el.find(".js-board-side-scroll-left").hide(),this.$el.find(".js-board-side-scroll-right").is(":hidden")&&this.$el.find(".js-board-side-scroll-right").show()):b("#board").scrollLeft()+b("#board").innerWidth()===b("#board")[0].scrollWidth?(this.$el.find(".js-board-side-scroll-right").hide(),this.$el.find(".js-board-side-scroll-left").is(":hidden")&&this.$el.find(".js-board-side-scroll-left").show()):this.$el.find("div[class*='js-board-side-scroll']").is(":hidden")&&this.$el.find("div[class*='js-board-side-scroll']").show():this.$el.find("div[class*='js-board-side-scroll']").hide()},startScrollBoardContent:function(a){var c=this;this.timer_continueScrollBoard=setTimeout(function(){c.flag_continueScrollBoard=!0},200);var d=b(a.target).parent().is(".js-board-side-scroll-left")?-50:50;this.timer_scrollBoard=setInterval(function(){c.flag_continueScrollBoard&&b("#board").stop().animate({scrollLeft:b("#board").scrollLeft()+d},50)},50)},stopScrollBoardContent:function(){this.flag_continueScrollBoard=!1,clearInterval(this.timer_continueScrollBoard),clearInterval(this.timer_scrollBoard)},buildScrollbar:function(a){a.css("overflow","hidden"),0===a.find(".scroll-content").length&&a.children().wrapAll('<div class="scroll-content"></div>');
var c=a.find(".scroll-content").height()-a.height();if(a.data("difference",c),0>=c&&a.find(".scroll-vbar-wrap").length>0&&(a.find(".scroll-vbar-wrap").remove(),a.find(".scroll-content").css({top:0})),c>0){var d=100*(1-Math.abs(a.find(".scroll-content").position().top)/c);0===a.find(".scroll-vbar-wrap").length&&(a.append('<div class="scroll-vbar-wrap"><div class="scroll-vbar"></div></div>'),d=100),a.find(".scroll-vbar-wrap").height(a.height()),a.find(".scroll-vbar").slider({orientation:"vertical",min:0,max:100,value:d,slide:function(b,d){a.find(".scroll-content").css({top:-((100-d.value)/100*c)})},change:function(b,c){a.find(".scroll-content").css({top:-((100-c.value)/100*(a.find(".scroll-content").height()-a.height()))})}});var e=Math.round(a.height()/a.find(".scroll-content").height()*a.height());a.find(".ui-slider-handle").css({height:e,"margin-bottom":-.5*e}),a.find(".scroll-vbar").css({height:a.height()-e,"margin-top":.5*e})}b(".scroll-vbar-wrap").click(function(a){b(this).find(".scroll-vbar").slider("value",100-(a.pageY-b(this).offset().top)/b(this).height()*100)}),b.fn.mousewheel&&a.on("mousewheel",function(c,d){var e=Math.round(5e3/a.data("difference"));1>e&&(e=1),e>100&&(e=100);var f=b(this).find(".scroll-vbar").slider("value");b(this).find(".scroll-vbar").slider("value",f+d*e),c.preventDefault()})},closeBoardClicked:function(){b(".js-toggle-board-menu").trigger("click"),confirm("Are you sure to close this board?")&&(this.model.off("change:isClosed"),this.model.patch({isClosed:!0}),cantas.appRouter.navigate("boards/closed",{trigger:!0,replace:!0}))},onBoardClosed:function(){var a=cantas.utils.getCurrentUser();if(this.model.get("creatorId")!==a.id&&this.model.attributes.isClosed){var c=b(".force-alert");c.find("p").text("This board is closed by board creator. Any further operation, please contact the creator."),c.find("a").attr("href","/boards/mine").text("Please go to home page!"),c.modal({backdrop:"static"})}}})}(jQuery,_,Backbone),function(a,b,c){"use strict";cantas.models.List=cantas.models.BaseModel.extend({idAttribute:"_id",noIoBind:!1,socket:cantas.socket,url:function(){return"/list"+(this.id?"/"+this.id:"")},initialize:function(){this.noIoBind||(this.ioBind("update",this.serverChange,this),this.ioBind("delete",this.serverDelete,this)),this.cardCollection=new cantas.models.CardCollection},dispose:function(){return this.off(),this.cardCollection.off(),this.noIoBind||(this.ioUnbindAll(),this.cardCollection.dispose()),this},validate:function(a){return void 0===a.title||0===a.length?"You must enter a title for list.":/^\s+$/.test(a.title)?"Please enter a effective title for list.":void 0},clear:function(a){this.destroy(a),this.modelCleanup()},serverChange:function(a){this.set(a)},serverDelete:function(){"object"==typeof this.collection?this.collection.remove(this):this.trigger("remove",this)},modelCleanup:function(){return this.ioUnbindAll(),this}}),cantas.models.ListCollection=c.Collection.extend({model:cantas.models.List,socket:cantas.socket,url:"/list",initialize:function(){b.bindAll(this,"serverCreate","serverMove"),this.noIoBind||(this.ioBind("create",this.socket,this.serverCreate,this),this.ioBind("move",this.socket,this.serverMove,this))},dispose:function(){return this.forEach(function(a){a.dispose()}),this.off(),this.noIoBind||this.ioUnbindAll(),this},serverMove:function(a){if(a){var b=cantas.utils.getCurrentBoardModel().listCollection,c=b.get(a._id);"undefined"==typeof c&&(b.add(a),c=b.get(a._id),c.trigger("change:order",c))}},serverCreate:function(a){if(a){var b=cantas.utils.getCurrentBoardModel().listCollection,c=b.get(a._id);"undefined"==typeof c&&(b.add(a),c=b.get(a._id)),c.trigger("change:order",c)}},collectionCleanup:function(){return this.ioUnbindAll(),this.each(function(a){a.modelCleanup()}),this},status:function(){return this.filter(function(a){return a.get("status")})},nextOrder:function(){if(!this.length)return 1;var a=b.max(this.pluck("order"),function(a){return a});return a+1},comparator:function(a){return a.get("order")}})}(jQuery,_,Backbone),function(b,c,d){"use strict";cantas.views.MoveItemView=d.View.extend({tagName:"li",template:jade.compile(b("#template-move-list-item").text()),initialize:function(){c.bindAll(this,"render")},events:{"click a":"checkedItem"},checkedItem:function(a){b(a.target).parent("li").addClass("checked").siblings("li").removeClass("checked")},render:function(){return this.$el.html(this.template({data:this.model})),this}}),cantas.views.MoveListToView=d.View.extend({el:"div.window-overlay",template:jade.compile(b("#template-move-list").text()),initialize:function(a){c.bindAll(this,"render"),this.boardId=a.boardId,this.listId=a.listId,this.title=a.title,this.boardCollection=new cantas.models.BoardCollection,this.listCollection=new cantas.models.ListCollection,this.boardMemberCollection=new cantas.models.BoardMemberCollection,this.syncconfigCollection=new cantas.models.SyncConfigCollection},_childrenViews:[],events:{"hidden.bs.modal":"closeWindowOverlay","keyup .js-move-search":"moveSearch","click .js-set-position":"setPosition","click .js-move":"onMoveListClick","click .choose-position > ul:eq(0) .js-move-items li.checked":"updatePositionSelection"},updatePositionSelection:function(a){var c=b(a.target).data("itemid");this.updateListPosition(c)},updateListPosition:function(a){var b=this,c=".choose-position li.specific a",d=".choose-position .js-move-position",e='a[data-itemid*="'+b.listId+'"]';this.$el.find(c).removeClass("checked"),this.listCollection.fetch({data:{boardId:a,isArchived:!1},success:function(a){b.$el.find(d).empty(),a.each(function(c){var e=new cantas.views.MoveItemView({model:{_id:c.id,title:a.indexOf(c)+1}});b._childrenViews.push(e),b.$el.find(d).append(e.render().el)}),b.$el.find(e).parent("li").addClass("checked")}})},updateBoardList:function(){var a=0;cantas.utils.renderMoveList(this,this.boardId,null,a)},onMoveListClick:function(a){var b=this.$el.find(".choose-position > ul:eq(0) .js-move-items li.checked a").data("itemid"),c=this.boardId;if(c!==b&&this.syncconfigCollection.length>0){var d=cantas.utils.getCurrentBoardView();d&&!d.confirmDialogView&&(d.confirmDialogView=new cantas.views.ConfirmDialogView),this.confirmMoveListToOtherBoard(a)}else this.moveAction(a)},confirmMoveListToOtherBoard:function(a){a.stopPropagation(),b("body").click();var c=this;cantas.utils.getCurrentBoardView().confirmDialogView.render({operationType:"move",operationItem:"list",confirmInfo:"Are you sure to move this list containing a mapping relation to the Bugzilla? If you do that, we will use another the same name of list(a existing list, or created one) for the coming sync bugs from Bugzilla.",captionYes:"Yes",yesCallback:function(){c.moveAction(),b("#confirm-dialog").hide()},captionNo:"Cancel",noCallback:function(){b("#confirm-dialog").hide()},diplayNoAskOrNo:!1,pageX:a.pageX,pageY:a.pageY-200,width:360})},moveAction:function(){var a=this.listId,b=this.$el.find(".choose-position > ul:eq(0) .js-move-items li.checked a").data("itemid"),c=this.$el.find(".choose-position .js-move-position li.checked a").data("label"),d={boardId:b,listId:a,position:c};cantas.socket.emit("move-list",d),this.$el.modal("hide")},setPosition:function(a){var c=b(a.target).data("position");b(a.target).addClass("checked").siblings("a").removeClass("checked"),this.movePositionShortcut(c)},movePositionShortcut:function(a){"top"===a&&this.moveTop(),"middle"===a&&this.moveMiddle(),"bottom"===a&&this.moveBottom()},moveTop:function(){var a=this.$el.find(".choose-position .js-move-position li:first");this.highlightBox(a),this.$(".js-move-position").scrollTop(0)},moveMiddle:function(){var a=Math.ceil(b(".choose-position .js-move-position li").length/2)-1,c=this.$el.find(".choose-position .js-move-position li:eq("+a+")");this.highlightBox(c)},moveBottom:function(){var a=this.$el.find(".choose-position .js-move-position li:last");this.highlightBox(a);var c=this.$(".js-move-position")[0];b(c).scrollTop(c.scrollHeight)},highlightBox:function(a){a.addClass("checked").siblings("li").removeClass("checked")},moveSearch:function(a){cantas.utils.renderMoveSearch(a)},render:function(){var a=this;this.$el.html(this.template({data:{title:a.title}})),a.$el.find(".choose-position > ul:eq(1)").hide(),this.$el.modal();a.boardId;return this.updateBoardList(),this.updateListPosition(this.boardId),this.syncconfigCollection.fetch({data:{listId:this.listId}}),this},remove:function(){return this.closeWindowOverlay(),this},closeWindowOverlay:function(){var a=this._childrenViews;c.each(a,function(b){b.remove(),a.pop(b)}),this.undelegateEvents(),this.stopListening(),this.$el.empty()}}),cantas.views.ListView=d.View.extend({tagName:"div",className:"list-panel js-list-panel",template:jade.compile(b("#template-list-view").text()),events:{"click .js-list-setting":"showListMenu","mouseenter header.list-header":"showListSettingIcon","mouseleave header.list-header":"hideListSettingIcon","click .js-list-title-text":"editListTitle","click .js-add-card":"showAddForm","click .js-cancel":"hideAddForm","click .js-btn-submit":"createCard","input #card-form":"autoResizeTextArea",dblclick:"onDoubleClick",listdrop:"listDrop",sortstop:"sortStop",sortreceive:"sortReceive","click header":"headerClicked"},initialize:function(){this._fetchCards(),this.model.on("change:title",this.titleChanged,this),this.model.on("change:isArchived",this.isArchivedChanged,this),this.model.on("change:order",this.refreshListOrder,this),this.model.on("remove",this.remove,this),this.model.cardCollection.on("add",this.onCardAddedToCollection,this),this.model.cardCollection.on("remove",this.onCardRemovedFromCollection,this),this.model.cardCollection.on("reset",this.addAll,this),this.model.cardCollection.on("add",this.updateCardQuantity,this),this.model.cardCollection.on("remove",this.updateCardQuantity,this),this.model.cardCollection.on("reset",this.updateCardQuantity,this),this.model.cardCollection.on("change:isArchived",this.updateCardQuantity,this),this.model.cardCollection.on("change:isArchived",this.addAll,this),this.cardViewCache={}},_fetchCards:function(){var a=this.model.id;this.model.cardCollection.fetch({data:{listId:a},reset:!0})},updateCardQuantity:function(){if(this.model.get("isArchived")===!1){var a=this.model.cardCollection.where({isArchived:!1}).length;this.$el.find(".js-card-quantity").html(a)}},updateCardsOrderNumber:function(){this.$el.find(".order-number").each(function(a,b){b.textContent=a+1})},remove:function(){return this.listMenuView&&this.listMenuView.remove(),c.each(this.cardViewCache,function(a){a.close()}),this.undelegateEvents(),this.stopListening(),this.$el.remove(),this.model.dispose(),this},render:function(){var a=this.$el.empty(),c=this.model.id;return a.attr("id",c),a.append(this.template(this.model.toJSON())),a.find(".list-content").css("max-height",b("#board").height()-90),this.renderCards(),window.cantas.isBoardMember||(this.$el.find(".js-add-card").hide(),this.undelegateEvents()),this},renderCards:function(){var a=this;return a.model.cardCollection?(a.model.cardCollection.each(function(b){c.each(a.cardViewCache,function(c){c.model.id===b.id&&(a.$(".list-content").append(c.render().el),c.delegateEvents())})}),a):a},onCardAddedToCollection:function(a,b){var c=b.where({isArchived:!1}).length;this.addOne(a,c,b)},onCardRemovedFromCollection:function(a){var b={};c.each(this.cardViewCache,function(a){b[a.model.id]=a.cid});var d=b[a.id];d&&(this.cardViewCache[d].close(),delete this.cardViewCache[d])},addAll:function(){var c=this,d=0;this.model.cardCollection.forEach(function(a){a.get("isArchived")===!1&&(d+=1),c.addOne(a,d)}),a.refreshCardSortable(),window.cantas.isBoardMember||b(".connectedSortable").sortable("disable")},addOne:function(b,d,e){var f=cantas.utils.getCurrentBoardView()._expandedViewChain,g={};c.each(this.cardViewCache,function(a){g[a.model.id]=a.cid});var h=g[b.id],i=null;if(h)i=this.cardViewCache[h],i.attributes.index=d;else{i=new cantas.views.CardView({model:b,attributes:{index:d,expandedViewChain:f}});var j=i.cid;this.cardViewCache[j]=i}if(b.get("isArchived")===!1){var k=this.$(".js-add-card-area");k.length>0?i.render().$el.insertBefore(k):this.$(".list-content").append(i.render().el),i.$el.show()}e&&(a.refreshCardSortable(),this.$(".card:last").addClass("card-highlight"),setTimeout(function(){this.$(".card.card-highlight").removeClass("card-highlight")},10),void 0!==b.attributes.creatorId&&b.attributes.creatorId===cantas.user.id&&this.$el.find(".js-list-content").animate({scrollTop:this.$el.find(".js-list-content")[0].scrollHeight+1e3},500))},showListMenu:function(a){a.stopPropagation(),this.listMenuView||(this.listMenuView=new cantas.views.ListMenuView),b("body").click();var c=0;a.pageX+b("#list-menu").width()>b(window).width()&&(c=a.pageX+b("#list-menu").width()-b(window).width()),this.listMenuView.render({listId:this.model.id,boardId:this.boardId,pageX:a.pageX-c,pageY:a.pageY}),b(a.target).show(),this.attributes.expandedViewChain=cantas.utils.rememberMe(this,this.attributes.expandedViewChain)},showListSettingIcon:function(){this.$el.find(".js-list-setting").show()},hideListSettingIcon:function(){(b("#list-menu").is(":hidden")||this.el.id!==b("#list-menu").attr("data-listId"))&&this.$el.find(".js-list-setting").hide()},isArchivedChanged:function(c){var d=this;c.get("isArchived")===!0?b(d.el).fadeOut("slow",function(){d.$el.hide(),cantas.utils.getCurrentBoardView().switchScrollButton()}):(b("#board").append(this.render().el),this.$el.show(),this._fetchCards()),a.refreshListSortable(),a.refreshCardSortable()},editListTitle:function(a){a.stopPropagation(),this.editAreaContainer=b(a.target).parent();b(a.target).text();this.restoreHTML=this.editAreaContainer.html();var c=this.editAreaContainer.find("span.js-card-quantity").clone().hide();this.editAreaContainer.html(b("#list-title-edit-placeholder").html()),this.editAreaContainer.find("div.edit-title").append(c),this.editAreaContainer.find("#title-input").on("keypress",this,this.titleInputKeypressed).val(this.model.get("title")).focus().select(),this.editAreaContainer.find(".js-save-list-title").on("click",this,this.saveListTitle),this.attributes.expandedViewChain=cantas.utils.rememberMe(this,this.attributes.expandedViewChain)},saveListTitle:function(a){var c=a.data,d=c.editAreaContainer.find("#title-input").val().trim();if(0===d.length)alert("Please enter a list title");else{{var e=c.model.get("title");c.model.set({title:d},{validate:!0})}c.model.hasChanged("title")&&(b("body").trigger("click"),c.model.patch({title:d,original:{title:e}}))}return!0},titleInputKeypressed:function(a){13===a.which&&b(a.target).parent().find(".js-save-list-title").trigger("click")},titleChanged:function(a){var c=a.get("title");b(this.el).find(".js-list-title-text").text(c).attr("title",c)},collapse:function(){this.editAreaContainer&&(this.editAreaContainer.find(".js-save-list-title").off("click",this,this.saveListTitle),this.editAreaContainer.html(this.restoreHTML.replace(/\d+<\/span>$/,this.editAreaContainer.find("span.js-card-quantity").text())),this.editAreaContainer.find(".js-list-title-text").text(this.model.get("title"))),this.listMenuView&&this.listMenuView.undelegateEvents(),this.attributes.expandedViewChain=cantas.utils.forgetMe(this,this.attributes.expandedViewChain)},headerClicked:function(a){a.stopPropagation()},showAddForm:function(a){a.preventDefault(),a.stopPropagation(),b(".hidden-option").remove(),b(".js-add-card").show();var c=jade.compile(b("#template-card-add-view").text()),d=this.$el.find(".list-content");d.append(c()),d.animate({scrollTop:d[0].scrollHeight},100),b("#card-form").select(),this.$el.find(".js-add-card").hide()},autoResizeTextArea:function(a){b(a.target).height(0),b(a.target).height(b(a.target)[0].scrollHeight),this.$el.find(".js-list-content").scrollTop(this.$el.find(".js-list-content")[0].scrollHeight)},hideAddForm:function(a){a.preventDefault(),b(a.target).closest(".hidden-option").remove(),this.$el.find(".js-add-card").show()},createCard:function(a){a.preventDefault();var c=b(a.target).closest(".hidden-option").find("textarea").val().trim();if(!c)return!1;var d=new cantas.models.Card({title:c,creatorId:cantas.user.id,listId:this.model.id,boardId:this.model.get("boardId"),order:this.calcPos()});d.save(),this.hideAddForm(a)},listDrop:function(a,b,c){b!==c&&this.$el.trigger("updatesort",[this.model,b,c])},onDoubleClick:function(a){return a.stopPropagation(),!0},refreshListOrder:function(d){var e=b("#board").find(".list-panel"),f=e.index(this.$el),g=cantas.utils.getCurrentBoardModel().listCollection;g.sort({silent:!0});var h=g.pluck("order"),i=c.indexOf(h,d.get("order"),!0);i>f&&b(this.el).parent().children().eq(i).after(b(this.el)),f>i&&b(this.el).parent().children().eq(i).before(b(this.el)),a.refreshListSortable(),a.refreshCardSortable(),b("body").trigger("click")},sortStop:function(a,b){a.stopPropagation(),this.triggerOnItem(a,b,"movefrom")},sortReceive:function(a,b){a.stopPropagation(),this.triggerOnItem(a,b,"movein")},triggerOnItem:function(a,b,d){var e=this;c.defer(function(){return b.item.trigger(d,[b,e])})},calcPos:function(){var a=-1,b=this.model.cardCollection.where({isArchived:!1});b=b.sort(function(a,b){return a-b});var d=b.length;if(0===d&&(a+=65536),d>0){var e=c.last(b).get("order");a=e+65536}return a}}),cantas.views.ListMenuView=d.View.extend({el:"div#list-menu",events:{"click .close":"hideListMenu","click .js-add-card":"addCard","click .js-archive-list":"archiveList","click .js-archive-all-cards":"archiveAllCards","click .js-move-list":"moveList"},initialize:function(){c.bindAll(this,"render","moveList"),b("body").on("click",function(){b(".list-menu,.js-list-setting").hide()})},render:function(a){return this.boardId=cantas.utils.getCurrentBoardId(),this.listId=a.listId,this.$el.attr("data-listId",this.listId),this.$el.css({left:a.pageX,top:a.pageY}),this.delegateEvents(),this.$el.toggle(),this},_getListModel:function(){return cantas.utils.getCurrentBoardModel().listCollection.findWhere({_id:this.listId})},addCard:function(a){this.hideListMenu(a),b("#"+this.listId+".list-panel").find(".js-add-card").trigger("click")},archiveList:function(a){this.hideListMenu(a);var b=this._getListModel();b.patch({isArchived:!0,original:{isArchived:!1}})},archiveAllCards:function(a){this.hideListMenu(a);var b=this._getListModel();b.patch({_archiveAllCards:!0})},moveList:function(a){this.hideListMenu(a),this.moveListToView=new cantas.views.MoveListToView({title:"Move List",listId:this.listId,boardId:this.boardId}),this.moveListToView.render()},hideListMenu:function(a){a.stopPropagation(),this.undelegateEvents(),this.$el.hide()},remove:function(){return this.moveListToView&&this.moveListToView.remove(),this.undelegateEvents(),this.stopListening(),this}})}(jQuery,_,Backbone),function(){"use strict";cantas.models.Checklist=cantas.models.BaseModel.extend({urlRoot:"checklist",initialize:function(){this.itemCollection=new cantas.models.ChecklistItemCollection([],{container:this});var a=cantas.models.BaseModel;a.prototype.initialize.apply(this,arguments)},dispose:function(){this.itemCollection&&this.itemCollection.dispose(),this.itemCollection=null;var a=cantas.models.BaseModel;a.prototype.dispose.apply(this,arguments)}}),cantas.models.ChecklistCollection=cantas.models.BaseCollection.extend({url:"/checklist",model:cantas.models.Checklist,initialize:function(a,b){this.noIoBind||this.ioBind("create",this.socket,this.serverCreate,this);var c=b||{};if(void 0===c.card)throw new Error("Missing card object.");this.card=c.card},comparator:function(a){return a.get("createdOn")},serverCreate:function(a){a.cardId===this.card.id&&this.add(a)},dispose:function(){this.card=null,this.noIoBind||this.ioUnbindAll();var a=cantas.models.BaseCollection;a.prototype.dispose.apply(this,arguments)}}),cantas.models.ChecklistItem=cantas.models.BaseModel.extend({urlRoot:"checklistitem"}),cantas.models.ChecklistItemCollection=cantas.models.BaseCollection.extend({url:"/checklistitem",model:cantas.models.ChecklistItem,initialize:function(a,b){this.noIoBind||this.ioBind("create",this.socket,this.serverCreate,this);var c=b||{};if(void 0===c.container)throw new Error("Missing container that ChecklistItem collection must have one.");this.container=c.container},serverCreate:function(a){a.checklistId===this.container.id&&this.add(a)},comparator:function(a){return a.get("order")}})}(jQuery,_,Backbone),function(a){"use strict";cantas.views.ChecklistSectionView=cantas.views.BaseView.extend({initialize:function(a){this.checklistViews={};var b=a||{};if(this.card=b.card,void 0===this.card)throw new Error("Missing card object");this.collection.on("add",this.onChecklistCreated,this),this.isConfirmDeleteChecklist=!0},render:function(){this.collection.fetch({data:{cardId:this.card.id}})},close:function(){var a,b=this.checklistViews;for(a in b)b.hasOwnProperty(a)&&b[a].close();this.collection.dispose();var c=cantas.views.BaseView;c.prototype.close.apply(this,arguments)},onChecklistCreated:function(a){var b=new cantas.views.ChecklistView({parentView:this,model:a,card:this.card});this.addChecklistView(b),b.renderAll();var c=cantas.utils.getCurrentUser(),d=a.get("authorId")===c.id;d&&b.addNewItem()},addChecklistView:function(a){this.$el.append(a.render().el),this.checklistViews[a.model.id]=a}}),cantas.views.ChecklistView=cantas.views.BaseView.extend({tagName:"section",className:"checklist",template:jade.compile(a("#template-card-checklist").text()),id:function(){return this.model.id},events:{"click .js-checklist-delete":"onDeleteClick","click .js-add-item a":"onAddItemClick","click .js-fold-items":"onFoldItems"},initialize:function(){this.itemViews={},this.model.itemCollection.on("add",this.onChecklistItemAdded,this),this.model.itemCollection.on("remove",this.onChecklistItemRemoved,this),this.model.on("remove",this.onModelRemove,this),this.isConfirmDeleteChecklistItem=!0},close:function(){var a,b=this.itemViews;for(a in b)b.hasOwnProperty(a)&&b[a].close();var c=cantas.views.BaseView;c.prototype.close.apply(this,arguments)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.$el.find("a.js-fold-items").hide(),window.cantas.isBoardMember||(this.undelegateEvents(),this.$el.find("li.js-add-item").hide(),this.$el.find("a.js-checklist-delete").hide()),cantas.utils.getCurrentUser().id!==this.model.attributes.authorId&&this.$el.find("a.js-checklist-delete").hide(),this},renderItems:function(){var a=this.model.itemCollection;a.fetch({data:{checklistId:this.model.id}})},renderAll:function(){this.render(),this.renderItems()},onChecklistItemAdded:function(a){this.itemViews[a.id]=this.appendNewItem(a),this.updateChecklistProgress()},onModelRemove:function(){this.close()},appendNewItem:function(a){var b=new cantas.views.ChecklistItemView({model:a,parentView:this});return this.$el.find("ul.js-items").append(b.render().el),b},onDeleteClick:function(b){if(null!==this.model){cantas.utils.getCurrentBoardView().confirmDialogView||(cantas.utils.getCurrentBoardView().confirmDialogView=new cantas.views.ConfirmDialogView);var c=this.options.parentView;c.isConfirmDeleteChecklist?(a(b.target.parentNode).focus(),this.confirmDeleteChecklist(b),a(".modal-scrollable").on("scroll",function(){a("body").click()})):this.removeChecklist()}},confirmDeleteChecklist:function(b){b.stopPropagation(),a("body").click();var c=this;cantas.utils.getCurrentBoardView().confirmDialogView.render({operationType:"delete",operationItem:"checklist",confirmInfo:"Are you sure to delete this checklist?",captionYes:"Delete",yesCallback:function(){c.removeChecklist(),a("#js-cb-noask:checked").length>0&&(c.options.parentView.isConfirmDeleteChecklist=!1),a("#confirm-dialog").hide()},captionNo:"Cancel",noCallback:function(){a("#confirm-dialog").hide()},pageX:b.pageX-285,pageY:b.pageY})},removeChecklist:function(){this.$el.fadeOut(),this.removeChecklistItems(),this.model.destroy()},removeChecklistItems:function(){var a={},b=this.model.itemCollection;b.forEach(function(b,c){a[c]=b});var c;for(c in a)a.hasOwnProperty(c)&&a[c].destroy()},onAddItemClick:function(b){a(b.target).parent().hide(),this._addNewItem()},addNewItem:function(){this.$el.find(".js-add-item a").trigger("click")},onFoldItems:function(){this.$el.find("ul").toggle("fade"),this.$el.find("a.js-fold-items").toggleClass("fold")},onChecklistItemRemoved:function(){this.updateChecklistProgress()},_addNewItem:function(){if(0===this.$("ul.js-item-entryview div.card-option-edit").length){var a=new cantas.views.ChecklistItemInputView({model:null,parentView:this});this.$el.find("ul.js-item-entryview").append(a.render().el),a.focus()}else this.$("ul.js-item-entryview div.card-option-edit textarea").focus()},updateChecklistProgress:function(){var a=this.model.itemCollection.where({checked:!0}).length,b=this.model.itemCollection.length,c=0;this.$el.find("a.js-fold-items").show(),0===b&&this.$el.find("a.js-fold-items").hide(),b>0&&(c=Math.round(a/b*100)),this.$el.find(".checklist-title .progress .bar").width(c+"%"),this.$el.find(".checklist-title .progress .bar a").text(c+"%")}}),cantas.views.ChecklistItemView=cantas.views.BaseView.extend({tagName:"li",template:jade.compile(a("#template-card-checkitem").text()),events:{"click .js-item-checkbox":"toggleItemDone","click .js-check-item-text":"onEditCheckitemClick","click .js-item-delete":"onDeleteItemClick"},initialize:function(){this.model.on("change:checked",this.checkedChanged,this),this.model.on("change:content",this.render,this),this.model.on("remove",this.onModelRemove,this)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.model.get("checked")&&this.$el.addClass("checked"),window.cantas.isBoardMember||(this.undelegateEvents(),this.$el.find("a.js-item-delete").hide()),this},onModelRemove:function(){this.close()},onEditCheckitemClick:function(){var a=new cantas.views.ChecklistItemInputView({model:this.model,parentView:this.options.parentView}),b=this.$el;b.hide(),b.after(a.render().el)},confirmDeleteChecklistItem:function(b){b.stopPropagation(),a("body").click();var c=this;cantas.utils.getCurrentBoardView().confirmDialogView.render({operationType:"delete",operationItem:"checklist item",confirmInfo:"Are you sure to delete this checklist item?",captionYes:"Delete",yesCallback:function(){c.removeChecklistItem(),a("#js-cb-noask:checked").length>0&&(c.options.parentView.isConfirmDeleteChecklistItem=!1),a("#confirm-dialog").hide()},captionNo:"Cancel",noCallback:function(){a("#confirm-dialog").hide()},pageX:b.pageX-285,pageY:b.pageY})},onDeleteItemClick:function(b){if(null!==this.model){cantas.utils.getCurrentBoardView().confirmDialogView||(cantas.utils.getCurrentBoardView().confirmDialogView=new cantas.views.ConfirmDialogView);var c=this.options.parentView;c.isConfirmDeleteChecklistItem?(a(b.target.parentNode).focus(),this.confirmDeleteChecklistItem(b),a(".modal-scrollable").on("scroll",function(){a("body").click()})):this.removeChecklistItem()}},removeChecklistItem:function(){this.$el.fadeOut(),this.model.destroy()},toggleItemDone:function(){var a=!this.model.get("checked"),b=this.model.get("checked");this.model.patch({checked:a,original:{checked:b}})},checkedChanged:function(){this.$el.toggleClass("checked"),this.options.parentView.updateChecklistProgress()}}),cantas.views.ChecklistItemInputView=cantas.views.ChecklistItemView.extend({tagName:"li",events:{"click .js-convert-item-to-card":"convertToCard"},initialize:function(){this.inputView=new cantas.views.EntryView({placeholder:"Item content",buttons:[{name:"confirm",eventHandler:this.onConfirmClick,data:{checklistView:this.options.parentView,parentView:this}},{name:"cancel",eventHandler:this.onCancelClick,data:{checklistView:this.options.parentView,parentView:this}}]})},focus:function(){this.inputView.focus()},render:function(){if(this.$el.html(this.inputView.render().el),null!==this.model){var a=this.model.get("content"),b=this.model.get("updatedOn"),c=this.model.get("createdOn"),d="<a class='js-convert-item-to-card'>Convert to Card</a>";c=cantas.utils.formatDate(c),b=cantas.utils.formatDate(b),this.$el.find("div.js-create-time").text("Creation:  "+c),b!==c&&this.$el.find("div.js-modify-time").text("Last Modified:  "+b),this.$el.find("textarea").val(a),this.$el.find(".js-entryview-cancel").after(d)}return this},onConfirmClick:function(a,b){var c=b.entryView.getText();if(0!==c.length)if(null!==b.parentView.model)if(c===b.parentView.model.attributes.content)b.checklistView.itemViews[b.parentView.model.id].$el.show(),b.entryView.remove(),b.parentView.remove();else{var d=b.parentView.model.get("content");b.parentView.model.patch({content:c,original:{content:d}}),b.checklistView.itemViews[b.parentView.model.id].$el.show(),b.entryView.remove(),b.parentView.remove()}else{var e=new cantas.models.ChecklistItem({content:c,checklistId:b.checklistView.model.id,cardId:b.checklistView.model.get("cardId"),authorId:cantas.utils.getCurrentUser().id});e.save(),b.entryView.$el.find("textarea").val("")}},onCancelClick:function(a,b){null!==b.parentView.model&&b.checklistView.itemViews[b.parentView.model.id].$el.show(),b.entryView.remove(),b.parentView.remove(),0===b.checklistView.$("ul.js-item-entryview div.card-option-edit").length&&b.checklistView.$el.find("li.js-add-item").show()},convertToCard:function(){if(null!==this.model){var a=this.model.get("content"),b=this.options.parentView.options.card,c=b.get("listId"),d=b.get("boardId"),e=cantas.utils.getCurrentBoardModel().listCollection.get(c).cardCollection,f=cantas.utils.calcPos(e),g=new cantas.models.Card({title:a,creatorId:cantas.utils.getCurrentUser().id,listId:c,boardId:d,order:f,sourceObject:{model:this.model.urlRoot,id:this.model.id,title:a}});g.save(),this.model.destroy(),this.remove()}}})}(jQuery,_,Backbone),function(a,b,c){"use strict";cantas.models.Card=cantas.models.BaseModel.extend({idAttribute:"_id",noIoBind:!1,socket:cantas.socket,url:function(){return"/card"+(this.id?"/"+this.id:"")},initialize:function(){this.commentCollection=new cantas.models.CommentCollection,this.attachmentCollection=new cantas.models.AttachmentCollection,this.noIoBind||(this.ioBind("update",this.serverChange,this),this.ioBind("delete",this.serverDelete,this))},dispose:function(){return this.off(),this.commentCollection.off(),this.attachmentCollection.off(),this.noIoBind||(this.ioUnbindAll(),this.commentCollection.dispose(),this.attachmentCollection.dispose()),this},clear:function(a){this.destroy(a),this.modelCleanup()},serverChange:function(a){this.set(a)},serverDelete:function(){"object"==typeof this.collection?this.collection.remove(this):this.trigger("remove",this)},modelCleanup:function(){return this.ioUnbindAll(),this},moveToList:function(a,c){var d=this,e=this.inListView;"undefined"==typeof e&&(e=a);var f=e.model.cardCollection.where({isArchived:!1});f=b.map(f,function(a){return a.get("order")}),f=f.sort(function(a,b){return a-b});var g,h,i,j,k=f.length,l=-1;if(e!==a&&0===k&&"undefined"==typeof f[c]&&"undefined"==typeof f[c+1]&&(l+=65536),e!==a&&k>0&&"undefined"==typeof f[c-1]&&"undefined"!=typeof f[c]&&(g=f[c],l=g/2),e!==a&&k>0&&"undefined"!=typeof f[c-1]&&"undefined"!=typeof f[c]&&(i=f[c-1],j=f[c],l=(i+j)/2),e!==a&&k>0&&"undefined"!=typeof f[c-1]&&"undefined"==typeof f[c]&&(h=f[c-1],l=h+65536),e===a&&k>0&&0===c&&(g=f[c],l=g/2),e===a&&k>0&&"undefined"!=typeof f[c-1]&&"undefined"!=typeof f[c]&&"undefined"!=typeof f[c+1]&&d.get("order")<f[c]&&(i=f[c],j=f[c+1],l=(i+j)/2),e===a&&k>0&&"undefined"!=typeof f[c-1]&&"undefined"!=typeof f[c]&&"undefined"!=typeof f[c+1]&&d.get("order")>f[c]&&(i=f[c-1],j=f[c],l=(i+j)/2),e===a&&k>0&&c===f.length-1&&(h=f[c],l=h+65536),a.model.id!==e.model.id){a.model.cardCollection.remove(d,{silent:!0}),e.model.cardCollection.add(d,{silent:!0});var m={};b.each(a.cardViewCache,function(a){m[a.model.id]=a.cid});var n=m[d.id];if(n){var o=a.cardViewCache[n];delete a.cardViewCache[n],e.cardViewCache[n]=o}a.updateCardQuantity(),e.updateCardQuantity(),a.updateCardsOrderNumber(),e.updateCardsOrderNumber()
}-1!==l&&(e===a&&d.patch({order:l,original:{order:d.order}},{silent:!0}),e!==a&&d.patch({order:l,listId:e.model.id,original:{listId:a.model.id}},{silent:!0}))}}),cantas.models.CardCollection=c.Collection.extend({model:cantas.models.Card,socket:cantas.socket,url:"/card",initialize:function(a,c){b.bindAll(this,"fetch"),c=c||{},this.filters=c.filters||{},this.orderBy=c.orderBy,this.paginate=c.paginate,this.pagination=c.pagination||{},this.socket.removeAllListeners("/card:create"),this.socket.removeAllListeners("/card:move"),this.socket.removeAllListeners("/card:archiveAllCards"),this.noIoBind||(this.ioBind("create",this.socket,this.serverCreate,this),this.ioBind("move",this.socket,this.serverMove,this),this.ioBind("archiveAllCards",this.socket,this.serverArchiveCards,this))},fetch:function(a){return a.data=b.compactObject({$query:b.extend({},this.filters,a.data),$sort:this.orderBy||null,$limit:this.paginate?this.pagination.limit:null,$skip:this.paginate?this.pagination.skip:null}),c.Collection.prototype.fetch.call(this,a)},fetchTotal:function(c,d){var e=this.socket||window.socket,f=a.Deferred();return e.emit("card:read",b.extend({$count:{$or:[{creatorId:cantas.user.id},{assignees:cantas.user.id},{subscribeUserIds:cantas.user.id}],title:{$regex:c,$options:"gi"}}},d||{}),function(a,b){return a?f.reject():void f.resolve(b||0)}),f.promise()},setFilters:function(a){return this.setPage(1),this.filters=a,this},setSort:function(a){return this.setPage(1),this.orderBy=a,this},setPage:function(a){return this.paginate||(this.paginate=!0),this.pagination.skip=this.pagination.limit*(a-1),this},setPerPage:function(a){return this.paginate||(this.paginate=!0),this.pagination.limit=a,this},dispose:function(){return this.forEach(function(a){a.dispose()}),this.off(),this},serverMove:function(a){if(a){var b=cantas.utils.getCurrentBoardModel().listCollection.get(a.listId),c=b.cardCollection,d=c.get(a._id);"undefined"==typeof d&&(c.add(a),d=c.get(a._id),d.trigger("change:order",d))}},serverArchiveCards:function(a){var b=a.listId||null,c=a.archivedCards||null;if(c&&b){var d=cantas.utils.getCurrentBoardModel().listCollection.get(b),e=d.cardCollection;c.forEach(function(a){var b=e.get(a._id);"undefined"==typeof b&&(e.add(a),b=e.get(a._id)),b.set(a)})}},serverCreate:function(a){if(a){var b=cantas.utils.getCurrentBoardModel().listCollection.get(a.listId),c=b.cardCollection,d=c.get(a._id);"undefined"==typeof d&&c.add(a)}},collectionCleanup:function(){return this.ioUnbindAll(),this.each(function(a){a.modelCleanup()}),this},status:function(){return this.filter(function(a){return a.get("status")})},nextOrder:function(){return this.length?this.last().get("order")+1:1},comparator:function(a){return this.orderBy?void 0:a.get("order")}})}(jQuery,_,Backbone),function(b,c,d){cantas.views.EntryView=d.View.extend({tagName:"div",className:"card-option-edit show",defaults:{placeholder:"",acceptEnterKey:!1,acceptEscKey:!0},events:{keypress:"onViewKeypress","click .js-entryview-confirm":"onButtonConfirmClick","click .js-entryview-cancel":"onButtonCancelClick","keypress textarea":"onInputKeypress"},initialize:function(a){var b=a||{};this._eventHandlers={};var c=b.placeholder;void 0!==c&&"string"==typeof c&&(this.defaults.placeholder=c);var d=b.acceptEscKey;void 0!==d&&"boolean"==typeof d&&(this.defautls.acceptEscKey=d);var e=b.acceptEnterKey;void 0!==e&&"boolean"==typeof e&&(this.defautls.acceptEnterKey=e);var f=b.buttons;void 0!==f&&this._handleCustomButtons(f)},getText:function(){return this.$el.find("textarea").val()},focus:function(){this.$el.find("textarea").focus()},trigger:function(a){var b=".js-entryview-"+a;this.$el.find(b).trigger("click")},render:function(){var a=this.defaults,b=c.template(this._templateContent());return this.$el.html(b(a)),this},_getEventHandler:function(a){return this._eventHandlers[a]},_templateContent:function(){return'<textarea placeholder="<%= placeholder %>"></textarea><button class="btn btn-primary js-entryview-confirm">Save</button><button class="btn js-entryview-cancel">Cancel</button><div class="item-time"><div class="js-create-time"></div><div class="js-modify-time"></div></div>'},_handleCustomButtons:function(a){var b=a.length-1;for(b;b>=0;b--){var c=a[b];if(c.eventHandler&&"function"==typeof c.eventHandler){var d=c.data||{};d.entryView=this,this._eventHandlers[c.name]={"function":c.eventHandler,data:d}}}},_callHandler:function(a,b){var c=this._getEventHandler(a);void 0===c?console.log("EntryView:"+a+":Not implemented."):c.function(b,c.data)},onButtonConfirmClick:function(a){this._callHandler("confirm",a)},onButtonCancelClick:function(a){this._callHandler("cancel",a)},onInputKeypress:function(a){var b=13;return a.which!==b||this.defaults.acceptEnterKey?void 0:(this.$el.find(".js-entryview-confirm").trigger("click"),!1)},onViewKeypress:function(a){var c=a.keyCode===b.ui.keyCode.ESCAPE&&this.defaults.acceptEscKey;return c?(this.$el.find(".js-entryview-cancel").trigger("click"),!1):void 0}}),window.cantas.MoveCardToView=d.View.extend({el:"div.window-overlay",template:jade.compile(b("#template-move-list").text()),initialize:function(a){c.bindAll(this,"render"),this.boardId=cantas.utils.getCurrentBoardId(),this.listId=a.listId,this.title=a.title,this.cardId=a.cardId,this.boardCollection=new cantas.models.BoardCollection,this.listCollection=new cantas.models.ListCollection,this.cardColleciton=new cantas.models.CardCollection,this.boardMemberCollection=new cantas.models.BoardMemberCollection},_childrenViews:[],events:{"hidden.bs.modal":"closeWindowOverlay","keyup .js-move-search":"moveSearch","click .js-set-position":"setPosition","click .choose-position > ul:eq(0) .js-move-items li.checked":"updateCheckedList","click .choose-position > ul:eq(1) .js-move-items li.checked":"renderCardPosition","click .js-move":"moveAction"},render:function(){this.$el.html(this.template({data:{title:this.title}})),this.$el.modal();var a=["board","list"];this.updateMoveList(a),this.updateCardPosition(this.listId)},setPosition:function(a){var c=b(a.target).data("position");b(a.target).addClass("checked").siblings("a").removeClass("checked"),this._movePositionShortcut(c)},_movePositionShortcut:function(a){"top"===a?this._moveTop():"middle"===a?this._moveMiddle():"bottom"===a&&this._moveBottom()},_moveTop:function(){var a=this.$el.find(".choose-position .js-move-position li:first");this._highlightBox(a),this.$(".js-move-position").scrollTop(0)},_moveMiddle:function(){var a=Math.ceil(b(".choose-position .js-move-position li").length/2)-1,c=this.$el.find(".choose-position .js-move-position li:eq("+a+")");this._highlightBox(c)},_moveBottom:function(){var a=this.$el.find(".choose-position .js-move-position li:last");this._highlightBox(a);var c=this.$(".js-move-position")[0];b(c).scrollTop(c.scrollHeight)},_highlightBox:function(a){a.addClass("checked").siblings("li").removeClass("checked")},moveAction:function(){var a=this.$el.find(".choose-position > ul:eq(0) .js-move-items li.checked a").data("itemid"),b=this.$el.find(".choose-position > ul:eq(1) .js-move-items li.checked a").data("itemid"),c=this.$el.find(".choose-position .js-move-position li.checked a").data("label"),d={boardId:a,listId:b,cardId:this.cardId,position:c};cantas.socket.emit("move-card",d),this.$el.modal("hide")},moveSearch:function(a){cantas.utils.renderMoveSearch(a)},updateCheckedList:function(a){var c=b(a.target).data("itemid"),d=1;cantas.utils.renderMoveList(this,c,this.listId,d)},renderCardPosition:function(a){var c=b(a.target).data("itemid");this.updateCardPosition(c)},updateCardPosition:function(a){{var b=this,c=".choose-position li.specific a",d=".choose-position .js-move-position";'a[data-itemid*="'+this.cardId+'"]'}this.$el.find(c).removeClass("checked"),this.cardColleciton.fetch({data:{listId:a,isArchived:!1},success:function(a){b.$el.find(d).empty(),a.each(function(c){var e=new cantas.views.MoveItemView({model:{_id:c.id,title:a.indexOf(c)+1}});b._childrenViews.push(e),b.$el.find(d).append(e.render().el)});var c=b.$el.find(".choose-position .js-move-position li:first");b._highlightBox(c)}})},updateMoveList:function(a){var b=this;a.forEach(function(d){var e=c.indexOf(a,d);cantas.utils.renderMoveList(b,b.boardId,b.listId,e)})},remove:function(){return this.closeWindowOverlay(),this},closeWindowOverlay:function(){var a=this._childrenViews;c.each(a,function(b){b.remove(),a.pop(b)}),this.undelegateEvents(),this.stopListening(),this.$el.empty()}}),cantas.views.CardView=d.View.extend({tagName:"div",className:"list-card ui-sortable js-list-card",template:jade.compile(b("#template-card-view").text()),events:{"keypress .edit":"updateOnEnter","click div.card-title":"showCardDetail","click .card-setting":"showCardMenu","mouseenter .card":"showCardSettingIcon","mouseleave .card":"hideCardSettingIcon",movefrom:"moveFrom",movein:"moveIn"},initialize:function(){c.bindAll(this,"render"),this.model.on("change",this.onModelChange,this),this.model.on("change:isArchived",this.isArchivedChanged,this),this.model.on("change:order change:listId",this.refreshCardOrder,this),this.model.on("remove",this.remove,this),this.cardLabelCollection=new cantas.models.CardLabelRelationCollection,this.voteCollection=new cantas.models.VoteCollection},onModelChange:function(){this.render(),this.refreshCardOrderNumber()},refreshCardOrderNumber:function(){var a=this.model,c=["listId","order","isArchived"],d=c.map(function(b){return a.hasChanged(b)}).reduce(function(a,b){return a&&b});if(d){var e=a.get("listId");b("#"+e).find(".order-number").each(function(a,c){b(c).text(a+1)})}},render:function(){var a=this.model.toJSON();return a.index=this.attributes.index,a.dueDateDisplay=this.getDueDateDisplay(),a.coverURL=this.getCoverUrl(a.cover),a.badges&&(a.badges.checkitems>0&&(a.checkitemsProgress=a.badges.checkitemsChecked+"/"+a.badges.checkitems),a.badgesVotes=a.badges.votesYes+"/"+a.badges.votesNo),this.$el.empty(),this.$el.html(this.template(a)),this.$el.attr("id",this.model.id),this.cardNeonLightsView=new cantas.views.LabelNeonLightsView({el:this.$el.find("div.card-filter.clearfix"),collection:new cantas.models.CardLabelRelationCollection,card:this.model}),this.cardNeonLightsView.turnOn(),window.cantas.isBoardMember||this.disableEvents(),this},disableEvents:function(){this.$el.undelegate(".card-setting","click"),this.$el.undelegate(".card","mouseenter"),this.$el.undelegate(".card","mouseleave")},close:function(){return this.cardMenuView&&this.cardMenuView.remove(),this.cardDetailView&&this.cardDetailView.remove(),this.cardNeonLightsView&&this.cardNeonLightsView.close(),this.model.dispose(),this.cardLabelCollection.dispose(),this.voteCollection.dispose(),this.remove(),this},getDueDateDisplay:function(){if(this.model.get("dueDate")){var a=this.model.get("dueDate"),b=new Date(a),c=window.moment.utc(b),d=c.calendar();return d}return!1},getCoverUrl:function(a){if(!a)return null;var b=window.location.protocol+"//"+window.location.host;return b+=a.slice(a.indexOf("/attachments")),'url("'+b+'")'},updateOnEnter:function(a){13===a.keyCode&&this.close()},isArchivedChanged:function(d){var e=this,f=c.map(cantas.utils.getCurrentBoardView().listViewCollection,function(a){return a.model.id}),g=c.indexOf(f,d.get("listId")),h=cantas.utils.getCurrentBoardView().listViewCollection[g];d.get("isArchived")===!0?b(e.el).fadeOut("slow",function(){e.$el.hide()}):h.model.get("isArchived")===!1&&(b(h.el).find(".list-content").append(this.render().el),this.$el.show()),a.refreshCardSortable()},showCardDetail:function(a){return a.stopPropagation(),cantas.appRouter.navigate("card/"+this.model.id+"/"+b.slug(this.model.get("title"))),this.cardDetailView=new cantas.views.CardDetailsView({model:this.model,cardLabelCollection:this.cardLabelCollection,voteCollection:this.voteCollection}),this.cardDetailView.render()},showCardMenu:function(a){a.stopPropagation(),this.cardMenuView||(this.cardMenuView=new cantas.views.CardMenuView),b("body").click();var c=cantas.utils.getOffsetX(a.pageX,"#card-menu");this.cardMenuView.render({cardId:this.model.id,listId:this.model.get("listId"),pageX:a.pageX-c,pageY:a.pageY}),b(a.target).show(),this.attributes.expandedViewChain=cantas.utils.rememberMe(this,this.attributes.expandedViewChain)},collapse:function(){this.cardMenuView&&this.cardMenuView.undelegateEvents(),this.attributes.expandedViewChain=cantas.utils.forgetMe(this,this.attributes.expandedViewChain)},showCardSettingIcon:function(){this.$el.find(".card-setting").show()},hideCardSettingIcon:function(){(b("#card-menu").is(":hidden")||this.el.id!==b("#card-menu").attr("data-cardId"))&&this.$el.find(".card-setting").hide()},moveFrom:function(a,b,c){var d=b.item.parent().children(".list-card:visible").index(b.item);cantas.views.fromListView=c,this.model.moveToList(c,d,b.item)},moveIn:function(a,b,c){this.model.inListView=c,cantas.views.inListView=c},refreshCardOrder:function(){var d=this,e=this.model,f=e.previousAttributes().listId,g=e.get("listId"),h=c.map(cantas.utils.getCurrentBoardView().listViewCollection,function(a){return a.model.id}),i=c.indexOf(h,g);if(-1===i)return console.log("[refreshCardOrder]the Card have not exist view in this Board"),!1;var j=cantas.utils.getCurrentBoardView().listViewCollection[i],k=c.indexOf(h,f),l=cantas.utils.getCurrentBoardView().listViewCollection[k];j.updateCardQuantity(),l&&(l.updateCardQuantity(),l.model.cardCollection.remove(e,{silent:!0})),j.model.cardCollection.add(e,{silent:!0}),j.cardViewCache[d.cid]=d;var m=j.model.cardCollection.where({isArchived:!1}),n=c.map(m,function(a){return a.get("order")});n=n.sort(function(a,b){return a-b});var o=c.indexOf(n,e.get("order"),!0),p=b(j.el).find("section > div.list-card"),q=null;if(l!==j&&-1===p.index(b(d.el))&&"undefined"==typeof p[o-1]&&"undefined"==typeof p[o]&&"undefined"==typeof p[o+1]&&(q="moveToEmptyList"),l!==j&&-1===p.index(b(d.el))&&"undefined"==typeof p[o-1]&&"undefined"!=typeof p[o]&&(q="moveToFirstInCardArray"),l!==j&&-1===p.index(b(d.el))&&"undefined"!=typeof p[o-1]&&"undefined"!=typeof p[o]&&(q="moveToInPositionInCardArray"),l!==j&&-1===p.index(b(d.el))&&"undefined"!=typeof p[o-1]&&"undefined"==typeof p[o]&&"undefined"==typeof p[o+1]&&(q="moveToLastPositionInNewList"),l===j&&p.index(b(d.el))!==o&&p[o]!==d&&0===o&&(q="moveToFirstPosition"),l===j&&p.index(b(d.el))!==o&&p[o]!==d&&o>0&&o<n.length&&e.get("order")<e.previous("order")&&(q="moveToInPositionFromTopToBottom"),l===j&&p.index(b(d.el))!==o&&p[o]!==d&&o>0&&o<n.length-1&&e.get("order")>e.previous("order")&&(q="moveFromBottomToTop"),l===j&&p.index(b(d.el))!==o&&p[o]!==d&&o===n.length-1&&(q="moveToLastInCardArray"),"undefined"==typeof l&&n.length>1&&0===o&&(q="moveToFirstPosition"),"undefined"==typeof l&&n.length>1&&o>0&&o<n.length&&(q="moveToInPositionFromTopToBottom"),"undefined"==typeof l&&n.length>1&&o===n.length-1&&(q="moveToLastInCardArray"),q){var r={moveToEmptyList:function(){b(j.el).find("section").append(b(d.el))},moveToFirstInCardArray:function(){p.eq(o).before(b(d.el))},moveToInPositionInCardArray:function(){p.eq(o).before(b(d.el))},moveToLastPositionInNewList:function(){p.eq(o-1).after(b(d.el))},moveToFirstPosition:function(){p.eq(o).before(b(d.el))},moveToInPositionFromTopToBottom:function(){p.eq(o).before(b(d.el))},moveFromBottomToTop:function(){p.eq(o).after(b(d.el))},moveToLastInCardArray:function(){p.eq(o).after(b(d.el))}};r[q](),this.refreshCardOrderNumber(),a.refreshCardSortable()}}}),cantas.views.CardDetailsView=cantas.views.CardView.extend({tagName:"div",el:b("#card-detail"),template:jade.compile(b("#template-card-detail-view").text()),events:{"click .js-edit-title":"openEditTitleDialog","click .js-edit-desc":"openEditDescDialog","click .js-edit-desc a":"openNewTab","click .js-save-title":"onTitleSaveClick","click .js-cancel-title":"onTitleCancelClick","click .js-save-desc":"onDescriptionSaveClick","click .js-cancel-desc":"onDescriptionCancelClick","click .js-archive-card":"archiveCard","click .js-edit-assign":"toggleAssignWindow","click .js-edit-label":"toggleLabelWindow","click .js-edit-vote":"toggleVoteWindow","click .js-edit-due-date":"toggleDueDateWindow","click .js-add-comment":"addComment","click .js-add-attachment":"addAttachment","hidden.bs.modal":"closeCardDetail","click .js-add-checklist":"onChecklistClick","click .js-subscribe":"onSubscribeClick"},initialize:function(a){this.model.on("change:title",this.titleChanged,this),this.model.on("change:description",this.descriptionChanged,this),this.model.on("change:assignees",this.assigneesChanged,this),this.model.on("change:subscribeUserIds",this.subscribeChanged,this),this.model.on("change:dueDate",this.dueDateChanged,this),this.commentTemplate=jade.compile(b("#template-comment-item-view").text()),this.cardLabelCollection=a.cardLabelCollection,this.voteCollection=a.voteCollection,this._expandedViewChain=[]},render:function(){var a=this,c=this.model.toJSON();c.assignees=this._concatAssignees(),c.description=markdown.toHTML(c.description),c.dueDate&&(c.dueDateDisplay=moment.utc(new Date(c.dueDate)).calendar()),b.when(this.$el.html(this.template({card:c}))).done(function(){return a.$el.modal(),cantas.setTitle("Card|"+a.model.get("title")),a.renderAssignView(),a.renderLabelView(),a.renderVoteView(),a.renderSubscribeStatus(),a.renderDueDateView(),a.renderCommentView(),a.renderAttachmentView(),a.cardVotesTotalView=new cantas.views.CardVotesTotalView({el:a.$el.find("a.card-vote"),collection:a.voteCollection,card:a.model}),a.cardVotesTotalView.render(),a.checklistSectionView=new cantas.views.ChecklistSectionView({el:a.$el.find("section.js-checklist-section"),collection:new cantas.models.ChecklistCollection([],{card:a.model}),card:a.model}),a.checklistSectionView.render(),a.detailsNeonLightsView=new cantas.views.LabelNeonLightsView({el:a.$el.find("div.card-filter.clearfix"),collection:new cantas.models.CardLabelRelationCollection,card:a.model}),a.detailsNeonLightsView.turnOn(),a.listenTo(a.detailsNeonLightsView,"setLabelCpation",a.toggleLabelCaption),a.fileupload=a.$el.find("#attachmentUpload").fileupload({autoUpload:!1,url:"/upload/"+c._id,maxFileSize:1e7,minFileSize:1,dataType:"json",messages:{maxFileSize:"File is too large, the maximum size is 10M.",minFileSize:"File is too small, the minimum size is 1B."}}).on("fileuploadadd",function(b,c){var d=new cantas.views.AttachmentUploadItemView({model:new cantas.models.Attachment(c.files[0]),data:c,parentView:a});c.context=d.render().$el;var e=a.$(".js-attachment-upload-table");0===e.find("tbody tr").length&&e.prepend("<thead><tr><th>Preview</th><th>File Name</th><th>Size</th></tr></thead>"),a.$(".js-attachment-upload-table tbody").append(c.context)}).on("fileuploadprocessalways",function(a,c){var d=c.files[0];d.preview&&c.context.find(".upload-preview").append(d.preview),d.error&&c.context.find(".upload-control").append(b("<p>",{"class":"upload-errormessage",text:d.error})).find(".upload-errormessage").prepend(b("<span>",{"class":"label label-important",text:"Error"})),c.context.find(".js-upload-start").text("Attach").prop("disabled",!!d.error)}).on("fileuploadprogress",function(a,b){var c=Math.floor(b.loaded/b.total*100);b.context.find(".js-upload-progress").prop("aria-valuenow",c).find(".bar").css("width",c+"%")}).on("fileuploaddone",function(b,c){if(c.context.find(".upload-errormessage").remove(),c.result.user_error)throw a.reportUploadError(c.context,c.result.user_error),new Error(c.result.maintainer_error);c.context.find(".js-upload-abort").text("Finished").prop("disabled",!0),c.context.fadeOut().remove();var d=a.$(".js-attachment-upload-table");0===d.find("tbody tr").length&&d.find("thead").remove();var e=new cantas.models.Attachment(c.result.attachment);e.save()}).on("fileuploadfail",function(b,c){c.context.find(".upload-errormessage").remove(),"abort"!==c.errorThrown&&a.reportUploadError(c.context,"Uploading attachment failed")}).on("fileuploadsubmit",function(b,c){return 0===c.files[0].size?(a.reportUploadError(c.context,"Uploading attachment failed"),c.context.find(".js-upload-start")[0].setAttribute("disabled","disabled"),!1):void 0}),window.cantas.isBoardMember||a.disableEvents(),a})},reportUploadError:function(a,c){a.find(".js-abort").removeClass("js-abort").addClass("js-start").text("Attach").prop("disabled",!1),a.find(".upload-control").append(b("<p>",{"class":"upload-errormessage",text:c})).find(".upload-errormessage").prepend(b("<span>",{"class":"label label-important",text:"Error"}))},onSubscribeClick:function(){var a=this.$el.find(".js-subscribe").text(),b=this.model.attributes.subscribeUserIds,d=c.clone(this.model.attributes.subscribeUserIds),e=cantas.utils.getCurrentUser().id,f=d.indexOf(e);"Subscribe"===a&&-1===f?(d.push(e),this.model.patch({subscribeUserIds:d,original:{subscribeUserIds:b}})):"Unsubscribe"===a&&f>=0&&(d.splice(f,1),this.model.patch({subscribeUserIds:d,original:{subscribeUserIds:b}}))},disableEvents:function(){this.$el.undelegate(".js-edit-title","click"),this.$el.undelegate(".js-edit-assign","click"),this.$el.undelegate(".js-edit-label","click"),this.$el.undelegate(".js-add-checklist","click"),this.$el.undelegate(".js-add-attachment","click"),this.$el.undelegate(".js-edit-desc","click"),this.$el.find("a .js-edit-desc").hide()},renderCommentView:function(){this.commentView=new cantas.views.CommentView({el:this.$el.find("section.card-option.comment"),model:this.model}),this.commentView.render()},renderAttachmentView:function(){this.attachmentView=new cantas.views.AttachmentView({el:this.$el.find("section.card-option.attachment"),model:this.model}),this.attachmentView.render()},renderSubscribeStatus:function(){var a=cantas.utils.getCurrentUser().id,b=this.model.attributes.subscribeUserIds;this.$el.find(".js-subscribe").text(b&&b.indexOf(a)>=0?"Unsubscribe":"Subscribe")},openEditTitleDialog:function(a){a.stopPropagation(),this.$el.find(".js-title").hide(),this.$el.find(".js-edit-title-area").show(),this.$el.find(".js-title-input").val(this.model.get("title")).select()},onTitleSaveClick:function(){var a=b(".js-title-input").val().trim(),c=this.model.get("title");return a?(this.model.set("title",a),this.model.hasChanged("title")&&this.model.patch({title:a,original:{title:c}}),this.$el.find(".js-title").show(),void this.$el.find(".js-edit-title-area").hide()):!1},titleChanged:function(){this.$el.find(".js-title").html(this.model.get("title"))},onTitleCancelClick:function(){return this.$el.find(".js-title").show(),this.$el.find(".js-edit-title-area").hide(),!1},openEditDescDialog:function(){this.$el.find(".js-edit-desc").hide(),this.$el.find(".js-edit-desc-area").show(),this.$el.find(".js-desc-input").val(this.model.get("description")).select()},openNewTab:function(a){a.stopPropagation(),a.preventDefault(),window.open(b(a.target).attr("href"))},onDescriptionSaveClick:function(a){a.stopPropagation();var b=this.$el.find(".js-desc-input").val().trim(),c=this.model.get("description");this.model.set("description",b),this.model.hasChanged("description")&&this.model.patch({description:b,original:{description:c}}),this.$el.find(".js-edit-desc").show(),this.$el.find(".js-edit-desc-area").hide(),this.$el.find(".js-desc-input").val("")},descriptionChanged:function(){var a=markdown.toHTML(this.model.get("description"));this.$el.find(".js-desc").html(a)},onDescriptionCancelClick:function(){return this.$el.find(".js-edit-desc").show(),this.$el.find(".js-edit-desc-area").hide(),this.$el.find(".js-desc-input").val(""),!1},renderAssignView:function(){this.cardAssignView=new cantas.views.CardAssignView({el:this.$el.find("div.window-assign"),model:this.model,attributes:{expandedViewChain:this._expandedViewChain}}),this.cardAssignView.render()},toggleAssignWindow:function(a){a.stopPropagation(),this.cardAssignView.isExpanded===!1?(this.cardAssignView.render(),this.cardAssignView.$el.show(),this.cardAssignView.isExpanded=!0,b(".modal-scrollable").scrollTop(0),this.cardAssignView.attributes.expandedViewChain=cantas.utils.rememberMe(this.cardAssignView,this.cardAssignView.attributes.expandedViewChain)):this.cardAssignView.collapse()},renderDueDateView:function(){this.cardDueDateView=new cantas.views.CardDueDateView({el:this.$el.find("div.window-due-date"),model:this.model,attributes:{expandedViewChain:this._expandedViewChain}}),this.cardDueDateView.render()},toggleDueDateWindow:function(a){a.stopPropagation(),this.cardDueDateView.isExpanded===!1?(this.cardDueDateView.render(),this.cardDueDateView.$el.show(),this.cardDueDateView.isExpanded=!0,b(".modal-scrollable").scrollTop(0),this.cardDueDateView.attributes.expandedViewChain=cantas.utils.rememberMe(this.cardDueDateView,this.cardDueDateView.attributes.expandedViewChain)):this.cardDueDateView.collapse()},renderLabelView:function(){this.labelAssignView=new cantas.views.LabelAssignView({el:this.$el.find("div.window-label"),collection:new cantas.models.CardLabelRelationCollection,card:this.model,parentView:this,attributes:{expandedViewChain:this._expandedViewChain}}),this.labelAssignView.render()},toggleLabelWindow:function(a){a.stopPropagation(),this.labelAssignView.isExpanded===!1?(this.labelAssignView.render(),this.labelAssignView.$el.show(),this.labelAssignView.isExpanded=!0,b(".modal-scrollable").scrollTop(0),this.labelAssignView.attributes.expandedViewChain=cantas.utils.rememberMe(this.labelAssignView,this.labelAssignView.attributes.expandedViewChain)):this.labelAssignView.collapse()},toggleLabelCaption:function(a){var b=this.$(".js-edit-label span").eq(0);a===!0?b.show():b.hide()},renderVoteView:function(){this.cardVoteView=new cantas.views.CardVoteView({el:this.$el.find("div.window-vote"),collection:this.voteCollection,card:this.model,attributes:{expandedViewChain:this._expandedViewChain}}),this.cardVoteView.render()},toggleVoteWindow:function(a){a.stopPropagation(),this.cardVoteView.isExpanded===!1?(this.cardVoteView.$el.show(),this.cardVoteView.isExpanded=!0,b(".modal-scrollable").scrollTop(0),this.cardVoteView.attributes.expandedViewChain=cantas.utils.rememberMe(this.cardVoteView,this.cardVoteView.attributes.expandedViewChain)):this.cardVoteView.collapse()},assigneesChanged:function(){var a=this._concatAssignees();this.$el.find(".js-assignees").html(a)},subscribeChanged:function(a){var b=a.attributes.subscribeUserIds,c=cantas.utils.getCurrentUser().id,d=b.indexOf(c);this.$el.find(".js-subscribe").text(b&&d>=0?"Unsubscribe":"Subscribe")},dueDateChanged:function(){var a=this.$(".js-edit-due-date"),b=this.model.get("dueDate");a.text(b?moment.utc(new Date(b)).calendar():"Due date")},canComment:function(){var a=cantas.utils.getCurrentCommentStatus(),b=!0;return"disabled"===a?b=!1:"enabled"!==a||window.cantas.isBoardMember||(b=!1),b},addComment:function(a){this.canComment()&&(a.stopPropagation(),this.$el.find(".js-add-comment-input").focus())},addAttachment:function(a){a.stopPropagation(),this.$('input[type="file"]').click()},closeCardDetail:function(){this.close()},close:function(){this.detailsNeonLightsView&&this.detailsNeonLightsView.remove(),this.checklistSectionView&&this.checklistSectionView.close(),this.commentView&&this.commentView.remove(),this.cardAssignView&&this.cardAssignView.remove(),this.cardDueDateView&&this.cardDueDateView.remove(),this.labelAssignView&&this.labelAssignView.remove(),this.cardVotesTotalView&&this.cardVotesTotalView.remove(),this.cardVoteView&&this.cardVoteView.remove(),this.cardDueDateView&&this.cardDueDateView.remove(),this.cardLabelCollection.dispose(),this.voteCollection.dispose(),this.$el.empty(),this.stopListening(),this.undelegateEvents();var a=cantas.utils.getCurrentBoardModel().id,c=cantas.utils.getCurrentBoardModel().get("title"),d=b.slug(c);return cantas.appRouter.navigate("board/"+a+"/"+d),cantas.setTitle("Board|"+c),this},archiveCard:function(a){a.stopPropagation(),this.model.patch({isArchived:!0,original:{isArchived:!1}}),this.$el.find(".js-close-card-detail").trigger("click")},onChecklistClick:function(){var a=(this.model,new cantas.views.EntryView({placeholder:"Checklist title",buttons:[{name:"confirm",eventHandler:function(a,b){var c=b.entryView.getText();if(0!==c.length){var d=new cantas.models.Checklist({title:c,cardId:b.card.id,authorId:cantas.utils.getCurrentUser().id});d.save(),b.entryView.trigger("cancel")}},data:{card:this.model}},{name:"cancel",eventHandler:function(a,b){b.entryView.remove()}}]}));this.$el.find("section.js-checklist-section").append(a.render().el),a.focus()},_concatAssignees:function(){var a=this.model.get("assignees");return a.length?c.pluck(a,"username").join(", "):"Assign..."}}),cantas.views.CardAssignView=d.View.extend({template:jade.compile(b("#template-card-assign-view").text()),events:{"click .js-select-assignee":"selectAssignee","click .js-save-assignee":"saveAssignee","click .js-close-assign-window":"collapse","click .js-cancel-assign-window":"onAssignCancelClick"},initialize:function(){this.isExpanded=!1},render:function(){var a=this._getMembersToAssign();this.$el.html(this.template({members:a}))},_getMembersToAssign:function(){var a=c.pluck(this.model.get("assignees"),"_id"),b=cantas.utils.getCurrentBoardView().memberCollection,d=b.toJSON().map(function(b){return b.checked=-1===a.indexOf(b.userId._id)?!1:!0,b});return d},selectAssignee:function(a){a.stopPropagation();var c=b(a.target),d=c.data("uid");d||(c=c.parent()),c.toggleClass("checked")},saveAssignee:function(a){a.stopPropagation();var d=[];b("ul.assignee li.checked").each(function(a,c){var e=b(c).data("uid");d.push(e)});var e=c.pluck(this.model.get("assignees"),"_id");c.isEqual(d.sort(),e.sort())||this.model.patch({assignees:d,original:{assignees:e}}),this.$el.find(".js-close-assign-window").trigger("click")},onAssignCancelClick:function(a){a.stopPropagation(),this.collapse()},collapse:function(){this.$el.hide(),this.isExpanded=!1,this.attributes.expandedViewChain=cantas.utils.forgetMe(this,this.attributes.expandedViewChain)}}),cantas.views.LabelAssignView=d.View.extend({template:jade.compile(b("#template-label-assign-view").text()),events:{"click .js-close-label-window":"collapse","click .label-items li":"toggleSelectStatus"},initialize:function(){this.isExpanded=!1,this.collection.on("change:selected",this.selectedChanged,this)},render:function(){var a=this;return this.loadLabelsOnlyOnce(function(){var b=a.collection.toJSON(),c={relations:b};a.$el.html(a.template(c))}),this},toggleSelectStatus:function(a){a.stopPropagation();var c=this.collection.get(b(a.target).closest("li").attr("id"));if(void 0!==c){var d=!c.get("selected");c.patch({selected:d})}},selectedChanged:function(a){this.$("#"+a.id).toggleClass("checked"),this.toggleLabelCaption(this.$("ul.label-items li.checked").length>0?!1:!0)},collapse:function(){this.$el.hide(),this.isExpanded=!1,this.attributes.expandedViewChain=cantas.utils.forgetMe(this,this.attributes.expandedViewChain)},toggleLabelCaption:function(a){var b=this.options.parentView.$(".js-edit-label span").eq(0);a===!0?b.show():b.hide()},loadLabelsOnlyOnce:function(a){this.lablesLoaded||this.collection.fetch({data:{boardId:this.options.card.boardId,cardId:this.options.card.id},success:function(b,c,d){this.labelsLoaded=!0,a(b,c,d)}})}}),cantas.views.CardMenuView=d.View.extend({el:"div#card-menu",events:{"click .js-archive-card":"archiveCard","click .js-move-card":"moveCard"},initialize:function(){c.bindAll(this,"render"),b("body").on("click",function(){b(".card-menu,.card-setting").hide()})},_getCardModel:function(){return cantas.utils.getCardModelById(this.cardId)},render:function(a){return this.cardId=a.cardId,this.listId=a.listId,this.$el.attr("data-cardId",this.cardId),this.$el.css({left:a.pageX,top:a.pageY}),this.delegateEvents(),this.$el.toggle(),this},archiveCard:function(a){this.hideCardMenu(a);var b=this._getCardModel();b.patch({isArchived:!0,original:{isArchived:!1}})},moveCard:function(a){this.hideCardMenu(a),this.moveCardToView=new cantas.MoveCardToView({title:"Move Card",listId:this.listId,cardId:this.cardId}),this.moveCardToView.render()},hideCardMenu:function(a){a.stopPropagation(),this.undelegateEvents(),this.$el.hide()},remove:function(){return this.moveCardToView&&this.moveCardToView.remove(),this.undelegateEvents(),this.stopListening(),this
}}),cantas.views.LabelNeonLightsView=d.View.extend({template:jade.compile(b("#template-card-labels-neonlights").text()),initialize:function(){this.collection.on("change:selected",this.render,this)},render:function(){var a={relations:this.collection.toJSON()};return this.$el.html(this.template(a)),this},turnOn:function(){var a=this;return a.collectionFetched?void a.render():void this.collection.fetch({data:{cardId:this.options.card.id},success:function(b){var c=!0;b.forEach(function(b){b.on("update:selected",a.render,a),b.toJSON().selected===!0&&(c=!1)}),a.trigger("setLabelCpation",c),a.collectionFetched=!0,a.render()}})},close:function(){this.collection.dispose(),this.remove()}}),cantas.views.CardVotesTotalView=d.View.extend({template:jade.compile(b("#template-card-votes-total-view").text()),initialize:function(){this.collection.on("add",this.render,this),this.collection.on("change",this.render,this),this.collection.on("remove",this.render,this)},render:function(){var a=this;this.collection.fetch({data:{cardId:this.options.card.id},success:function(b){var c=b.where({yesOrNo:!0}).length,d=b.length-c,e={voteYes:c,voteNo:d};a.$el.html(a.template(e));var f=b.findWhere({authorId:cantas.utils.getCurrentUser().id});if(void 0!==f){var g=f.attributes.yesOrNo;g===!0?a.$el.find("span.agree").addClass("checked"):g===!1&&a.$el.find("span.disagree").addClass("checked")}return a}})}}),cantas.views.CardVoteView=d.View.extend({template:jade.compile(b("#template-card-vote-view").text()),events:{"click .js-close-vote-window":"collapse","click .js-vote-agree":"voteYes","click .js-vote-disagree":"voteNo"},initialize:function(){this.isExpanded=!1,this.voteFlag=""},render:function(){var a=this,b=this.canVote();return"opened"===b&&this.collection.fetch({data:{cardId:this.options.card.id,authorId:cantas.utils.getCurrentUser().id},success:function(b){var c=b.findWhere({authorId:cantas.utils.getCurrentUser().id});if(void 0!==c){var d=c.attributes.yesOrNo;a.renderMyVote(d)}}}),this.$el.html(this.template({voteControl:b})),this},canVote:function(){var a,b=cantas.utils.getCurrentBoardModel();return a="opened"===b.attributes.voteStatus?"opened":"disabled"===b.attributes.voteStatus?"closed":"enabled"===b.attributes.voteStatus&&window.cantas.isBoardMember?"opened":"disabled"},renderMyVote:function(a){switch(a){case!0:b("#card-agree, span.agree").addClass("checked"),this.voteFlag="agree";break;case!1:b("#card-disagree, span.dis").addClass("checked"),this.voteFlag="disagree"}},voteYes:function(){var a=this.collection.findWhere({authorId:cantas.utils.getCurrentUser().id});switch(this.voteFlag){case"agree":b("#card-agree, span.agree").removeClass("checked"),this.voteFlag="",a.destroy();break;case"disagree":b("#card-disagree, span.disagree").removeClass("checked"),b("#card-agree, span.agree").addClass("checked"),this.voteFlag="agree",a.patch({yesOrNo:!0});break;default:b("#card-agree, span.agree").addClass("checked"),this.voteFlag="agree";var c=new cantas.models.Vote({cardId:this.options.card.id,authorId:cantas.utils.getCurrentUser().id});c.save(),this.collection.add(c)}},voteNo:function(){var a=this.collection.findWhere({authorId:cantas.utils.getCurrentUser().id});switch(this.voteFlag){case"agree":b("#card-agree, span.agree").removeClass("checked"),b("#card-disagree, span.disagree").addClass("checked"),this.voteFlag="disagree",a.patch({yesOrNo:!1});break;case"disagree":b("#card-disagree, span.disagree").removeClass("checked"),this.voteFlag="",a.destroy();break;default:b("#card-disagree, span.disagree").addClass("checked"),this.voteFlag="disagree";var c=new cantas.models.Vote({yesOrNo:!1,cardId:this.options.card.id,authorId:cantas.utils.getCurrentUser().id});c.save(),this.collection.add(c)}},collapse:function(){this.$el.hide(),this.isExpanded=!1,this.attributes.expandedViewChain=cantas.utils.forgetMe(this,this.attributes.expandedViewChain)}}),cantas.views.CardDueDateView=cantas.views.BaseView.extend({template:jade.compile(b("#template-card-due-date-view").text()),events:{"click .js-save":"save","click .js-delete":"delete","click .js-close":"collapse","focus .js-due-date":"showCalendar","focus .js-due-time":"showClock"},initialize:function(){this.isExpanded=!1},render:function(){var a,b=this;return a=this.model.get("dueDate")?moment.utc(new Date(this.model.get("dueDate"))):null,this.$el.html(this.template(c.extend({},this.model,{dueDate:a?a.format("DD/MM/YYYY"):null,dueTime:a?a.format("hh:mm A"):null}))),this.$calendar=this.$(".js-datepicker").datepicker({altField:this.$('[name="due-date"]'),altFormat:"dd/mm/yy",defaultDate:a?a.format("MM/DD/YYYY"):null,minDate:new Date,onSelect:function(){b.validateDateTime()||b.resetDueDate()}}).hide(),this.$clock=this.$(".js-timepicker").timepicker({timeOnly:!0,timeFormat:"hh:mm TT",altField:this.$('[name="due-time"]'),altFieldTimeOnly:!0,stepMinute:10,hour:a?a.format("HH"):23,minute:a?a.format("mm"):59,onSelect:function(){b.validateDateTime()||b.resetDueDate()}}).hide(),this},showCalendar:function(){b(".js-due-date").blur(),this.$clock.hide(),this.$calendar.show()},showClock:function(){b(".js-due-time").blur(),this.$clock.show(),this.$calendar.hide()},resetDueDate:function(){var a=new Date,b=6e5,c=new Date(Math.ceil(a.getTime()/b)*b);this.$(".js-datepicker").datepicker("setDate",c),this.$(".js-timepicker").timepicker("setTime",c)},getUserInput:function(){var a=this.$(".js-due-date").val(),b=this.$(".js-due-time").val();return window.moment(a+" "+b,"DD/MM/YYYY hh:mm A")},validateDateTime:function(){var a=this.getUserInput();return a.isValid()&&!a.isBefore()},"delete":function(){this.model.patch({dueDate:null}),this.collapse()},save:function(){var a=this.getUserInput();a.isValid()&&this.model.patch({dueDate:a.toJSON()}),this.collapse()},collapse:function(){this.$el.hide(),this.isExpanded=!1,this.attributes.expandedViewChain=cantas.utils.forgetMe(this,this.attributes.expandedViewChain)}}),cantas.views.StaticCardView=cantas.views.CardView.extend({className:"list-card list-card-static js-list-card",metaTemplate:jade.compile(b("#template-card-meta-view").text()),events:{"click div.card":"showCardDetails"},initialize:function(){cantas.views.CardView.prototype.initialize.apply(this),c.bindAll(this,"showCardDetails")},render:function(){return cantas.views.CardView.prototype.render.apply(this),this.$el.removeAttr("id"),(this.model.get("board").isClosed||this.model.get("isArchived")===!0)&&this.$el.addClass("card-closed"),this.$(".card-container").append(this.metaTemplate({meta:this.getMetaString()})),this},showCardDetails:function(){var a=this.model.get("board");if(a.isClosed)return cantas.appRouter.navigate("/boards/closed?highlighted="+a._id,{trigger:!0});if(this.model.get("isArchived")){var c="/board/"+a._id+"/"+b.slug(a.title)+"?view=archived.cards&highlighted="+this.model.get("_id");return cantas.appRouter.navigate(c,{trigger:!0})}var d="/card/"+this.model.get("_id")+"/"+b.slug(this.model.get("title"));cantas.appRouter.navigate(d,{trigger:!0})},getMetaString:function(){return this.model.get("list")&&this.model.get("board")?"Posted under "+this.model.get("list").title+' in <a href="/board/'+this.model.get("board")._id+'">'+this.model.get("board").title+"</a>":null}})}(jQuery,_,Backbone),function(){"use strict";cantas.models.Comment=cantas.models.BaseModel.extend({idAttribute:"_id",noIoBind:!1,socket:cantas.socket,url:function(){return"/comment"+(this.id?"/"+this.id:"")},initialize:function(){this.on("modelCleanup",this.modelCleanup,this),this.noIoBind||(this.ioBind("update",this.serverChange,this),this.ioBind("delete",this.serverDelete,this))},serverChange:function(a){this.set(a)},serverDelete:function(){"object"==typeof this.collection?this.collection.remove(this):this.trigger("remove",this)},modelCleanup:function(){return this.ioUnbindAll(),this}}),cantas.models.CommentCollection=cantas.models.BaseCollection.extend({model:cantas.models.Comment,socket:cantas.socket,url:"/comment",initialize:function(){this.socket.removeAllListeners("/comment:create"),this.socket.on("/comment:create",this.serverCreate,this)},serverCreate:function(a){if(a){var b=cantas.utils.getCardModelById(a.cardId);b&&b.commentCollection.add(a)}},collectionCleanup:function(){return this.ioUnbindAll(),this.each(function(a){a.modelCleanup()}),this},comparator:function(a,b){return a.get("createdOn")>b.get("createdOn")?1:a.get("createdOn")<b.get("createdOn")?-1:0}})}(jQuery,_,Backbone),function(a,b,c){"use strict";cantas.views.CommentView=c.View.extend({template:jade.compile(a("#template-comment-view").text()),events:{"click .js-save-comment":"saveComment","focus .js-add-comment-input":"showControls","click .js-cancel-comment":"hideControls"},initialize:function(){this.model.commentCollection.on("add",this.renderComment,this),this.model.commentCollection.fetch({data:{cardId:this.model.id}})},render:function(){return this.$el.html(this.template()),this.renderCommentItems(),this.controlComment(),this},controlComment:function(){var a=cantas.utils.getCurrentCommentStatus();"disabled"===a?this.$el.find(".js-add-comment-input").hide():"enabled"!==a||window.cantas.isBoardMember||this.$el.find(".js-add-comment-input").hide()},renderCommentItems:function(){var a=this;this.model.commentCollection.forEach(function(b){a.renderComment(b)})},renderComment:function(a){var b=new cantas.views.CommentItemView({model:a});this.$el.find(".comment-list").prepend(b.render().el)},saveComment:function(a){a.stopPropagation();var b=this.$el.find(".js-add-comment-input").val().trim();if(""===b)return!1;var c=new cantas.models.Comment({content:b,cardId:this.model.id,authorId:cantas.utils.getCurrentUser().id});c.save(),this.hideControls()},showControls:function(){this.$el.find(".js-comment-controls").show()},hideControls:function(){this.$el.find(".js-comment-controls").hide(),this.$el.find(".js-add-comment-input").val("")}}),cantas.views.CommentItemView=c.View.extend({tagName:"dl",className:"clearfix",template:jade.compile(a("#template-comment-item-view").text()),events:{"click .js-edit-comment":"editComment","click span.speaker-detail a":"openNewTab"},initialize:function(){this.model.on("change",this.render,this)},render:function(){var a=this.model.toJSON();return a.content=markdown.toHTML(a.content),this.$el.html(this.template(a)),this.controlComment(),this},controlComment:function(){var a=cantas.utils.getCurrentCommentStatus();"disabled"===a?this.$el.find("a.js-edit-comment").hide():"enabled"!==a||window.cantas.isBoardMember||this.$el.find("a.js-edit-comment").hide()},editComment:function(b){b.stopPropagation();a(b.target).data("cid");this.$el.find("dd").hide();var c=new cantas.views.CommentItemEditView({model:this.model});this.$el.find("dd").after(c.render().el),c.$el.find(".js-comment-input").select()},openNewTab:function(b){b.preventDefault(),window.open(a(b.target).attr("href"))}}),cantas.views.CommentItemEditView=c.View.extend({tagName:"div",className:"edit-comment",template:jade.compile(a("#template-comment-item-edit-view").text()),events:{"click .js-save-comment":"saveEditedComment","click .js-cancel-comment":"closeEditor"},render:function(){this.$el.html(this.template());var a=this.model.get("content");return this.$el.find(".js-comment-input").val(a).select(),this},saveEditedComment:function(a){a.stopPropagation();var b=this.$el.find(".js-comment-input").val().trim();if(""===b)return!1;if(this.closeEditor(a),b!==this.model.get("content")){var c=this.model.get("content");this.model.patch({content:b,original:{content:c}})}},closeEditor:function(a){a.stopPropagation(),this.$el.siblings("dd").show(),this.$el.remove()}})}(jQuery,_,Backbone),function(){"use strict";cantas.models.Attachment=cantas.models.BaseModel.extend({idAttribute:"_id",noIoBind:!1,socket:cantas.socket,url:function(){return"/attachment"+(this.id?"/"+this.id:"")},initialize:function(){this.noIoBind||(this.ioBind("update",this.serverChange,this),this.ioBind("delete",this.serverDelete,this))},serverChange:function(a){this.set(a)},serverDelete:function(){"object"==typeof this.collection?this.collection.remove(this):this.trigger("remove",this)},modelCleanup:function(){return this.ioUnbindAll(),this}}),cantas.models.AttachmentCollection=cantas.models.BaseCollection.extend({model:cantas.models.Attachment,socket:cantas.socket,url:"/attachment",initialize:function(){this.socket.removeAllListeners("/attachment:create"),this.socket.on("/attachment:create",this.serverCreate,this)},serverCreate:function(a){if(a){var b=cantas.utils.getCardModelById(a.cardId);b&&b.attachmentCollection.add(a)}},collectionCleanup:function(){return this.ioUnbindAll(),this.each(function(a){a.modelCleanup()}),this},comparator:function(a,b){return a.get("createdOn")>b.get("createdOn")?1:a.get("createdOn")<b.get("createdOn")?-1:0}})}(jQuery,_,Backbone),function(a,b,c){"use strict";cantas.views.AttachmentView=c.View.extend({template:jade.compile(a("#template-attachment-view").text()),events:{},initialize:function(){this.listenTo(this.model.attachmentCollection,"add",this.renderAttachmentDownloadItem),this.model.attachmentCollection.fetch({data:{cardId:this.model.id}}),this.isConfirmDeleteAttatchment=!0},render:function(){var a=this.model.toJSON();return a.isBoardMember=window.cantas.isBoardMember,this.$el.html(this.template(a)),this.renderAllAttachmentDownloadItems(),this},renderAllAttachmentDownloadItems:function(){var a=this;this.model.attachmentCollection.each(function(b){a.renderAttachmentDownloadItem(b)})},renderAttachmentDownloadItem:function(a){var b=new cantas.views.AttachmentDownloadItemView({model:a,parentView:this}),c=this.$(".js-attachment-download-table");if(0===c.find("tbody tr").length){var d="<thead><tr><th>Cover</th><th>Thumbnail</th><th>File Name</th><th>Size</th><th>Uploader Name</th><th>Upload Time</th><th></th></tr></thead>";c.prepend(d)}this.$(".js-attachment-download-table tbody").prepend(b.render().el)}}),cantas.views.AttachmentUploadItemView=cantas.views.BaseView.extend({tagName:"tr",className:"template-upload fade js-template-upload",template:jade.compile(a("#template-attachment-upload-view").text()),events:{"click .js-upload-start":"startUpload","click .js-upload-abort":"abortUpload","click .js-upload-delete":"deleteUpload"},render:function(){var a=this.model.toJSON();return a.fileSize=cantas.utils.formatFileSize(a.size),this.$el.html(this.template(a)),this},startUpload:function(b){b.stopPropagation(),this.options.data.submit(),a(b.target).removeClass("js-upload-start").addClass("js-upload-abort").text("Abort")},abortUpload:function(b){b.stopPropagation(),this.options.data.abort(),a(b.target).removeClass("js-upload-abort").addClass("js-upload-start").text("Attach"),a(b.target).closest("tr.js-template-upload").children("td.upload-size").find(".js-upload-progress").prop("aria-valuenow",0).find(".bar").css("width","0%")},deleteUpload:function(a){a.stopPropagation(),this.options.data.abort();var b=this.options.parentView.$el.find(".js-attachment-upload-table");1===b.find("tbody tr").length&&b.find("thead").remove(),this.close()}}),cantas.views.AttachmentDownloadItemView=cantas.views.BaseView.extend({tagName:"tr",className:"template-download fade js-template-download",template:jade.compile(a("#template-attachment-download-view").text()),events:{"click .js-download-delete":"onDeleteClick","click .js-download-cover":"toggleCover"},initialize:function(){this.listenTo(this.model,"remove",this.onModelRemove),this.listenTo(this.model,"change:isCover",this.isCoverChanged)},render:function(){var a=this.model.toJSON();a.fileName=a.name.slice(a.name.indexOf("-")+1),a.url="/attachments/"+a.cardId+"/"+a.name,a.thumbnail=a.cardDetailThumbPath?window.location.protocol+"//"+window.location.host+a.cardDetailThumbPath.slice(a.cardDetailThumbPath.indexOf("/attachments")):"",a.size=cantas.utils.formatFileSize(a.size),a.createdOn=cantas.utils.formatDate(a.createdOn),a.isBoardMember=window.cantas.isBoardMember,a.isUploader=a.uploaderId._id.toString()===cantas.utils.getCurrentUser().id.toString()?!0:!1;var b=cantas.utils.getCurrentBoardView().model.attributes.creatorId,c="object"==typeof b?b._id:b;return a.isBoardAdmin=cantas.user.id===c?!0:!1,this.$el.html(this.template(a)),this.model.get("isCover")&&this.$el.addClass("checked"),window.cantas.isBoardMember||this.undelegateEvents(),this},onModelRemove:function(){this.close();var a=this.options.parentView.$(".js-attachment-download-table");0===a.find("tbody tr").length&&a.find("thead").remove()},onDeleteClick:function(b){b.stopPropagation(),cantas.utils.getCurrentBoardView().confirmDialogView||(cantas.utils.getCurrentBoardView().confirmDialogView=new cantas.views.ConfirmDialogView);var c=this.options.parentView;c.isConfirmDeleteAttatchment?(this.confirmDeleteAttachment(b),a(".modal-scrollable").on("scroll",function(){a("body").click()})):(this.$el.fadeOut().remove(),this.model.destroy())},confirmDeleteAttachment:function(b){b.stopPropagation(),a("body").click();var c=this;cantas.utils.getCurrentBoardView().confirmDialogView.render({operationType:"delete",operationItem:"attachment",confirmInfo:"Are you sure to delete this attachment?",captionYes:"Delete",yesCallback:function(){c.model.destroy(),a("#js-cb-noask:checked").length>0&&(c.options.parentView.isConfirmDeleteAttatchment=!1),a("#confirm-dialog").hide()},captionNo:"Cancel",noCallback:function(){a("#confirm-dialog").hide()},pageX:b.pageX-290,pageY:b.pageY})},isCoverChanged:function(){this.$el.toggleClass("checked")},toggleCover:function(){var a=!this.model.get("isCover"),b=this.model.get("isCover");this.model.patch({isCover:a,cardId:this.model.toJSON().cardId,original:{isCover:b}})}})}(jQuery,_,Backbone),function(a,b){"use strict";{var c=cantas.models.BaseModel;cantas.models.BaseCollection}cantas.models.Vote=c.extend({urlRoot:"vote",initialize:function(){this.on("modelCleanup",this.modelCleanup,this),this.noIoBind||(this.ioBind("update",this.serverChange,this),this.ioBind("delete",this.serverDelete,this))},serverChange:function(a){this.set(a)},serverDelete:function(){"object"==typeof this.collection?this.collection.remove(this):this.trigger("remove",this)},modelCleanup:function(){return this.ioUnbindAll(),this}}),cantas.models.VoteCollection=cantas.models.BaseCollection.extend({model:cantas.models.Vote,url:"/vote",initialize:function(){b.bindAll(this,"serverCreate"),this.socket.removeAllListeners("/vote:create"),this.noIoBind||this.socket.on("/vote:create",this.serverCreate,this)}})}(jQuery,_,Backbone),function(a){"use strict";cantas.views.BoardsView=cantas.views.BaseView.extend({events:{"click .js-close-board":"closeBoard","click .js-open-board":"openBoard","click .js-view-board":"viewBoard"},template:jade.compile(a("#template-board-list-view").text()),closeBoard:function(b){var c=a(b.target).data("board"),d=new cantas.models.Board({_id:c});d.patch({isClosed:!0},{validate:!1}),a(b.target).closest("li").fadeOut("slow",function(){a(b.target).closest("li").remove()})},openBoard:function(b){var c=a(b.target).data("board"),d=new cantas.models.Board({_id:c});d.patch({isClosed:!1},{validate:!1}),a(b.target).closest("li").fadeOut("slow",function(){a(b.target).closest("li").remove()})},viewBoard:function(b){b.preventDefault(),cantas.navigateTo(a(b.target).attr("href"))},remove:function(){return this.undelegateEvents(),this.$el.empty(),this.stopListening(),this},render:function(a){var b;switch(a.title){case"mine":b="My Boards";break;case"public":b="Public Boards";break;case"closed":b="Closed Boards"}return this.$el.html(this.template({boards:a.boards,h3Header:b,isCreator:this.isCreator,highlighted:a.highlighted})),cantas.setTitle(a.title),this},isCreator:function(a){return a.creatorId._id===cantas.user.id}})}(jQuery,_,Backbone),function(a,b){"use strict";cantas.views.CardListView=cantas.views.BaseView.extend({childViews:[],events:{},template:jade.compile(a("#template-card-list-view").text()),cardCounter:0,initialize:function(){this.render()},render:function(){return cantas.setTitle(this.options.title),this.$el.html(this.template({h3Header:this.options.title})),this.cardIndex=new cantas.views.CardIndexView({el:this.$(".card-archive"),collection:this.collection,columns:4,paginate:!0,perPage:20}),this.renderSidebar(),this},renderSidebar:function(){var a=(new cantas.views.SidebarView).render();this.childViews.push(a),a.addPanel(new cantas.views.CardFilterPanelView({context:a,collection:this.collection})),a.addPanel(new cantas.views.CardSortPanelView({context:a,collection:this.collection})),this.$el.append(a.$el)},close:function(){this.cardIndex.close(),this.remove()},remove:function(){return this.undelegateEvents(),this.$el.empty(),this.stopListening(),this}}),cantas.views.CardIndexView=cantas.views.BaseView.extend({columns:4,childViews:[],paginate:!1,page:1,perPage:20,noResultsTemplate:jade.compile(a("#template-card-list-view-no-results").text()),loadMoreTemplate:jade.compile(a("#template-card-list-load-more").text()),events:{"click .js-load-more":"loadMore"},initialize:function(a){b.bindAll(this,"renderCard"),this.columns=a.columns||4,this.paginate=a.paginate||!1,this.perPage=a.perPage||20,this.listenTo(this.collection,"add",this.renderCard),this.listenTo(this.collection,"remove",this.removeCard),this.listenTo(this.collection,"reset",this.render),this.render()},render:function(){this.reset();var a=this.$el.html('<div class="card-container"></div>');return this.columns&&a.addClass("columns-"+this.columns),this.childViews=[],this.$cardContainer=a.find(".card-container"),this.collection.forEach(this.renderCard,this),this.renderPagination(),this},renderCard:function(a){var b=new cantas.views.StaticCardView({model:a,attributes:{index:null}});this.childViews.push(b),b.render().$el.appendTo(this.$cardContainer),this.renderPagination()},removeCard:function(a){b.each(this.childViews,function(b){a.get("_id")===b.model.get("_id")&&b.close()})},renderPagination:function(){this.paginate&&!this.$(".load-more").length&&this.$el.append(this.loadMoreTemplate()),this.paginate&&this.collection.size()<this.perPage&&this.lastPage()},loadMore:function(){var a=this;this.loading(!0),this.collection&&this.paginate&&this.collection.setPage(++this.page).fetch({add:!0,remove:!1,success:function(b,c){a.loading(!1),(!c||c.length<a.perPage)&&a.lastPage()}})},loading:function(a){a?this.$(".load-more").addClass("loading"):this.$(".load-more").removeClass("loading")},lastPage:function(){this.$(".load-more").remove()},reset:function(){this.page=1},close:function(){b.each(this.childViews,function(a){a.close()}),this.remove()},remove:function(){return this.undelegateEvents(),this.$el.empty(),this.stopListening(),this}})}(jQuery,_,Backbone),function(a,b,c){"use strict";cantas.views.HelpView=c.View.extend({el:".content",events:{},template:jade.compile(a("#template-help-view").text()),close:function(){this.remove()},remove:function(){return this.undelegateEvents(),this.$el.empty(),this.stopListening(),this},render:function(a){this.$el.html(this.template()),cantas.setTitle(a.title)}})}(jQuery,_,Backbone),function(a,b,c){"use strict";cantas.views.WelcomeView=c.View.extend({el:".content",events:{},template:jade.compile(a("#template-welcome-view").text()),close:function(){return this},render:function(b){this.$el.html(this.template()),cantas.setTitle(b.title);var c=a("#nav-arrows"),d=a("#nav-dots > span"),e=a("#slider").slitslider({onBeforeChange:function(a,b){d.removeClass("nav-dot-current"),d.eq(b).addClass("nav-dot-current")}});c.children(":last").on("click",function(){return e.next(),!1}),c.children(":first").on("click",function(){return e.previous(),!1}),d.each(function(b){a(this).on("click",function(){var c=a(this);return e.isActive()||(d.removeClass("nav-dot-current"),c.addClass("nav-dot-current")),e.jump(b+1),!1})})}})}(jQuery,_,Backbone),function(a,b,c){"use strict";cantas.views.DashboardView=c.View.extend({el:".content",events:{},contentView:null,navigationView:null,template:jade.compile(a("#template-dashboard-layout-view").text()),initialize:function(){b.bindAll(this,"setContentView","setNavigationView")},render:function(){return this.$el.html(this.template()),this.renderChildViews(),this},setContentView:function(a){return this.contentView=a,this},setNavigationView:function(a){return this.navigationView=a,this},renderChildViews:function(){return this.navigationView&&this.$el.find(".dashboard-navigation").append(this.navigationView.$el),this.contentView&&this.$el.find(".dashboard-content").append(this.contentView.$el),this},close:function(){this.contentView&&this.contentView.close(),this.navigationView&&this.navigationView.close(),this.remove()},remove:function(){return this.undelegateEvents(),this.$el.empty(),this.stopListening(),this}})}(jQuery,_,Backbone),function(a){"use strict";cantas.views.DashboardNavigationView=cantas.views.BaseView.extend({events:{"click a":"openDashboard"},template:jade.compile(a("#template-dashboard-navigation-view").text()),initialize:function(){},setActive:function(a){return this.$el.find("a.active").removeClass("active"),this.$el.find("a."+a).parents("li").addClass("active"),this},render:function(){return this.$el.html(this.template()),this},openDashboard:function(b){b.preventDefault(),cantas.navigateTo(a(b.target).attr("href"))},remove:function(){return this.undelegateEvents(),this.$el.empty(),this.stopListening(),this}})}(jQuery,_,Backbone),function(a,b,c){"use strict";cantas.views.ConfirmDialogView=c.View.extend({tagName:"div",id:"confirm-dialog",className:"alert-window clearfix",template:b.template('<h4>Delete Option</h4><p class="js-confirmInfo"></p><div class="alert-checkbox"><label class="inline" for="js-cb-noask"><input type="checkbox" id="js-cb-noask" />No more asking</label></div><button class="btn btn-small btn-primary js-btn-yes">Yes</button><button class="btn btn-small js-btn-no">No</button>'),initialize:function(){a("body").on("click",function(b){for(var c=b||window.event,d=c.srcElement||c.target;d&&d!==a("body")[0];){if("confirm-dialog"===d.id)return;d=d.parentNode}a("#confirm-dialog").hide()})},render:function(b){a("body").append(this.$el.html(this.template())),this.operationType=b.operationType,this.operationItem=b.operationItem,this.$el.find(".js-confirmInfo").text(b.confirmInfo),this.$el.find(".js-btn-yes").text(b.captionYes),this.$el.find(".js-btn-yes").on("click",b.yesCallback),this.$el.find(".js-btn-no").text(b.captionNo),this.$el.find(".js-btn-no").on("click",b.noCallback),b.diplayNoAskOrNo||this.$el.find("#js-cb-noask").parent().remove();var c=cantas.utils.getOffsetX(b.pageX,"#confirm-dialog"),d=cantas.utils.getOffsetY(b.pageY,"#confirm-dialog"),e={left:b.pageX-c,top:b.pageY-d};return e.width=b.width?b.width:240,this.$el.css(e),this.$el.toggle(),this}})}(jQuery,_,Backbone),function(){"use strict";cantas.models.BoardVisitor=cantas.models.BaseModel.extend({urlRoot:"boardvisitor"}),cantas.models.BoardVisitorCollection=cantas.models.BaseCollection.extend({url:"/boardvisitor",model:cantas.models.BoardVisitor,initialize:function(){this.noIoBind||this.ioBind("create",this.serverCreate,this)}})}(jQuery,_,Backbone),function(a,b,c){"use strict";var d=c.View.extend({tagName:"div",className:"scroll-content-item",initialize:function(){this.render=b.bind(this.render,this),this.model.on("change:username",this.render)},render:function(){var a=this.model.get("role"),b="<p>"+this.model.get("username")+'</p><div class="role-'+a.name+'" title="'+a.desc+'"></div>';return this.el.innerHTML=b,this},remove:function(){return this.undelegateEvents(),this.stopListening(),this.$el.remove(),this.model.dispose(),this}});cantas.views.BoardActiveUserCollectionView=c.View.extend({initialize:function(a){this._visitorViews={},this.collection.on("add",this.addChange,this),this.collection.on("remove",this.removeChange,this),this.boardId=a.boardId,this.socketInit()},remove:function(){return b.each(this._visitorViews,function(a){a.remove()}),this._visitorViews={},this.$el.empty(),this.undelegateEvents(),this.stopListening(),this},removeChange:function(b){var c=this;if(c._visitorViews[b.id]){var d=c._visitorViews[b.id];delete c._visitorViews[b.id],a(d.el).fadeOut("slow",function(){d.remove()})}},addChange:function(a){var b=this,c=new d({model:a});b._visitorViews[a.id]=c,b.$el.find(".scroll-content").append(c.render().el)},socketInit:function(){var a=this,b=cantas.socket;b.removeAllListeners("user-login:board:"+a.boardId),b.removeAllListeners("user-logout:board:"+a.boardId),b.removeAllListeners("user-leave-all-room"),b.on("user-login:board:"+a.boardId,function(b){var c=new cantas.models.BoardVisitor(b.visitor);a.collection.add(c)}),b.on("user-logout:board:"+a.boardId,function(b){var c=a.collection.get({id:b.visitor._id});a.collection.remove(c)}),b.on("user-leave-all-room",function(b){var c=a.collection.get({id:b.visitor._id});a.collection.remove(c)})},render:function(){a(this.el).empty();var b=this;return this.collection.forEach(function(c){var e=new d({model:c});b._visitorViews[c.id]=e,a(b.el).append(e.render().el)}),this}})}(jQuery,_,Backbone),function(a,b,c){"use strict";cantas.views.ConfigView=c.View.extend({el:"div.config-window",template:jade.compile(a("#template-admin-config-view").text()),events:{"hidden.bs.modal":"closeConfigView"},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.voteConfig=new cantas.views.VoteConfig({model:this.model}),this.voteConfig.render(),this.commentConfig=new cantas.views.CommentConfig({model:this.model}),this.commentConfig.render(),this},modal:function(){this.$el.modal()},show:function(){this.render().modal()},closeConfigView:function(){this.voteConfig.close(),this.commentConfig.close(),this.$el.empty(),this.undelegateEvents(),this.stopListening()}}),cantas.views.VoteConfig=c.View.extend({el:"dl.js-vote",template:jade.compile(a("#template-vote-config-view").text()),events:{"click .js-disable-vote span:last":"onDisableVoteClick","click .js-enable-vote span:last":"onEnableVoteClick","click .js-open-vote span:last":"onOpenVoteClick"},initialize:function(){this.model.on("change:voteStatus",this.render,this)},render:function(){this.$el.html(this.template(this.model.toJSON()));var b,c=this.model.toJSON().voteStatus;return b="opened"===c?a(".js-open-vote")[0]:"enabled"===c?a(".js-enable-vote")[0]:a(".js-disable-vote")[0],this.selectCheckedVoteStatus(b),this},close:function(){this.remove()},selectCheckedVoteStatus:function(b){var c=this.$el.find("dl.js-vote a"),d=c.index(a(b)),e=c.index(c.filter(".checked"));d>e&&c.slice(0,d).removeClass("via").children().removeClass("via"),c.removeClass("checked").children().removeClass("checked"),a(b).addClass("via checked").nextAll().addClass("via").end().children("span:first").addClass("via").end().children("span:eq(1)").addClass("checked")},onDisableVoteClick:function(a){this.changeVoteStatus(a.target.parentNode,"disabled")},onEnableVoteClick:function(a){this.changeVoteStatus(a.target.parentNode,"enabled")},onOpenVoteClick:function(a){this.changeVoteStatus(a.target.parentNode,"opened")},changeVoteStatus:function(b,c){if(!a(b).hasClass("checked")){var d=this.model.get("voteStatus");this.model.set("voteStatus",c),this.model.patch({voteStatus:c,original:{voteStatus:d}}),this.selectCheckedVoteStatus(b)}}}),cantas.views.CommentConfig=c.View.extend({el:"dl.js-comment",template:jade.compile(a("#template-comment-config-view").text()),events:{"click .js-disable-comment span:last":"onDisableCommentClick","click .js-enable-comment span:last":"onEnableCommentClick","click .js-open-comment span:last":"onOpenCommentClick"},initialize:function(){this.model.on("change:commentStatus",this.render,this)},render:function(){this.$el.html(this.template(this.model.toJSON()));var b,c=this.model.toJSON().commentStatus;return b="opened"===c?a(".js-open-comment")[0]:"enabled"===c?a(".js-enable-comment")[0]:a(".js-disable-comment")[0],this.selectCheckedCommentStatus(b),this},close:function(){this.remove()},selectCheckedCommentStatus:function(b){var c=this.$el.find("dl.js-comment a"),d=c.index(a(b)),e=c.index(c.filter(".checked"));d>e&&c.slice(0,d).removeClass("via").children().removeClass("via"),c.removeClass("checked").children().removeClass("checked"),a(b).addClass("via checked").nextAll().addClass("via").end().children("span:first").addClass("via").end().children("span:eq(1)").addClass("checked")
},onDisableCommentClick:function(a){this.changeCommentStatus(a.target.parentNode,"disabled")},onEnableCommentClick:function(a){this.changeCommentStatus(a.target.parentNode,"enabled")},onOpenCommentClick:function(a){this.changeCommentStatus(a.target.parentNode,"opened")},changeCommentStatus:function(b,c){if(!a(b).hasClass("checked")){var d=this.model.get("commentStatus");this.model.set("commentStatus",c),this.model.patch({commentStatus:c,original:{commentStatus:d}}),this.selectCheckedCommentStatus(b)}}})}(jQuery,_,Backbone),function(a,b){"use strict";cantas.views.SidebarView=cantas.views.BaseView.extend({className:"side-bar",panels:[],events:{"click .panel-container":function(a){a.stopPropagation()},"click .sidebar-items li":"togglePanel"},template:jade.compile(a("#template-sidebar-view").text()),initialize:function(){return this.panels=[],this},render:function(){return this.$el.empty(),this.$el.append(this.template()),this.renderSidebar(),this},renderSidebar:function(){if(this.panels&&this.panels.length){var a=this.$(".sidebar-items").empty();b.each(this.panels,function(b){b.renderLink().appendTo(a)})}},getPanel:function(a){return b.find(this.panels,function(b){return b.id===a})},addPanel:function(a){this.panels.push(a),this.renderSidebar()},removePanel:function(a){this.panels=b.without(this.panels,a),this.renderSidebar()},togglePanel:function(b){b.preventDefault(),b.stopPropagation();var c=a(b.target).parents("li").attr("data-panel"),d=this.getPanel(c);return d.isOpen?this.closePanel(d):void this.openPanel(d)},openPanel:function(b){this.closePanels();this.$(".panel-container").append(b.render().$el).show();a(document).on("click.sidebar.close",this.closePanels.bind(this)),b.isOpen=!0},closePanel:function(b){this.$(".panel-container").hide().empty();a(document).off("click.sidebar.close"),b.isOpen=!1,b.close()},closePanels:function(){b.each(this.panels,function(a){a.isOpen&&this.closePanel(a)}.bind(this))},remove:function(){this.undelegateEvents(),this.$el.remove(),this.stopListening()}}),cantas.views.CardFilterPanelView=cantas.views.BaseView.extend({context:null,isOpen:!1,defaultFilters:{keyword:null,created:!0,subscribed:!0,assigned:!0,dueDate:"any",archived:!1},className:"sidebar-panel panel-filter",id:b.uniqueId("card-panel-"),template:jade.compile(a("#template-card-filter-panel-view").text()),linkTemplate:jade.compile(a("#template-card-filter-panel-link-view").text()),events:{"submit .js-filter-form":"submitAction"},initialize:function(){return this.context=this.options.context,this.filters=this.defaultFilters,this},render:function(){return this.delegateEvents(),this.$el.html(this.template(this.filters)),this},renderLink:function(){return a(this.linkTemplate({total:this.totalActiveFilters(),panel:this.id}))},submitAction:function(a){a.preventDefault(),this.filterCollection(),this.context.renderSidebar()},filterCollection:function(){a("body div.process-loading").show(),this.getFilters(),this.collection.setFilters(this.morphFilters()),this.collection.fetch({reset:!0,success:function(){a("body div.process-loading").hide()},error:function(){a("body div.process-loading").hide()}})},getFilters:function(){return this.filters=b.extend({},this.defaultFilters,{keyword:this.$(".js-cardfilter-keyword").val(),created:this.$(".js-cardfilter-created").is(":checked"),subscribed:this.$(".js-cardfilter-subscribed").is(":checked"),assigned:this.$(".js-cardfilter-assigned").is(":checked"),dueDate:this.$(".js-cardfilter-dueDate:checked").val(),archived:this.$(".js-cardfilter-archived").is(":checked"),closed:this.$(".js-cardfilter-closed").is(":checked")}),this.filters},totalActiveFilters:function(){var a=b.compact(b.toArray(this.filters)).length;return"any"===this.filters.dueDate&&a--,a},morphFilters:function(){var a={};if(b.isString(this.filters.keyword)&&this.filters.keyword.length&&(a.title={$regex:this.filters.keyword,$options:"gi"}),this.filters.created||this.filters.assigned||this.filters.subscribed?(a.$or=[],this.filters.created===!0&&a.$or.push({creatorId:cantas.user.id}),this.filters.assigned===!0&&a.$or.push({assignees:cantas.user.id}),this.filters.subscribed===!0&&a.$or.push({subscribeUserIds:cantas.user.id})):a.$or=[{creatorId:cantas.user.id},{assignees:cantas.user.id},{subscribeUserIds:cantas.user.id}],this.filters.archived===!1&&(a.isArchived=!1),this.filters.dueDate&&"any"!==this.filters.dueDate){var c=this.getDateRange(this.filters.dueDate);a.dueDate={$gte:{type:"date",value:c.from},$lt:{type:"date",value:c.to}}}return a},getDateRange:function(a){var b=moment(),c=moment();return"day"===a&&c.add("days",1),"week"===a&&c.add("weeks",1),"month"===a&&c.add("months",1),{from:b,to:c}},remove:function(){this.undelegateEvents(),this.$el.remove(),this.stopListening()}}),cantas.views.CardSortPanelView=cantas.views.BaseView.extend({context:null,isOpen:!1,defaultSort:{field:"created",order:"DESC"},className:"sidebar-panel panel-sort",id:b.uniqueId("card-panel-"),template:jade.compile(a("#template-card-sort-panel-view").text()),linkTemplate:jade.compile(a("#template-card-sort-panel-link-view").text()),events:{"submit .js-sort-form":"submitAction"},initialize:function(){return this.context=this.options.context,this.sort=this.defaultSort,this},render:function(){return this.delegateEvents(),this.$el.html(this.template(this.sort)),this},renderLink:function(){return a(this.linkTemplate({panel:this.id}))},submitAction:function(a){a.preventDefault(),this.sortCollection(),this.context.renderSidebar()},sortCollection:function(){a("body div.process-loading").show(),this.getSortOptions(),this.collection.setSort(this.morphSort()),this.collection.fetch({reset:!0,success:function(){a("body div.process-loading").hide()},error:function(){a("body div.process-loading").hide()}})},getSortOptions:function(){return this.sort=b.extend({},this.defaultSort,{field:this.$(".js-cardsort-field:checked").val(),order:this.$(".js-cardsort-order:checked").val()}),this.sort},morphSort:function(){var a={},b="ASC"===this.sort.order?1:-1;switch(this.sort.field){case"board":a.boardId=b;break;case"due":a.dueDate=b;break;default:a.created=b}return a.title=1,a},remove:function(){this.undelegateEvents(),this.$el.remove(),this.stopListening()}})}(jQuery,_,Backbone),$(function(a,b,c){"use strict";window.cantas=window.cantas||{};var d=!1,e=c.Router.extend({routes:{"":"home","boards/new":"newBoard","boards/:query":"listBoards","cards/:query":"listCards","board/:boardId(/:slug)":"joinBoard","card/:cardId(/:slug)":"renderCardDetail",help:"help",account:"accountSettings",welcome:"welcome","search/:query":"search"},currentView:null,initialize:function(){this.appView=new cantas.views.AppView},switchView:function(a,b){this.currentView&&this.currentView.close();var c=cantas.socket;if(this.currentView&&this.currentView.boardTitleView){var d=this.currentView.model.id;c.emit("user-logout",{boardId:d,user:cantas.utils.getCurrentUser()})}if(this.currentView=a,this.currentView.render(b),a&&a.boardTitleView){var e=a.model.id;c.emit("join-board",e)}},home:function(){cantas.utils.isBrowserVersionLow()?cantas.utils.renderBrowserVesionPrompt():this.navigate("boards/mine",{trigger:!0,replace:!0})},listBoards:function(b){if(cantas.utils.isBrowserVersionLow())return cantas.utils.renderBrowserVesionPrompt();var c=cantas.utils.getQueryStringParam("highlighted");-1!==b.indexOf("?")&&(b=b.split("?")[0]);var d=(new cantas.views.DashboardView).render();d.setNavigationView((new cantas.views.DashboardNavigationView).render().setActive("nav-boards-"+b)),a("body div.process-loading").show(),a.ajax({url:"/api/"+b}).done(function(e){a("body div.process-loading").hide();var f=(new cantas.views.BoardsView).render({title:b,boards:e,highlighted:c});d.setContentView(f),this.switchView(d)}.bind(this)).fail(function(){return cantas.utils.renderTimeoutBox(),!1})},listCards:function(b){var c=this;if(cantas.utils.isBrowserVersionLow())return cantas.utils.renderBrowserVesionPrompt();var d=(new cantas.views.DashboardView).render();d.setNavigationView((new cantas.views.DashboardNavigationView).render().setActive("nav-cards-"+b)),a("body div.process-loading").show(),(new cantas.models.CardCollection).setPage(1).setPerPage(20).setFilters({$or:[{creatorId:cantas.user.id},{assignees:cantas.user.id},{subscribeUserIds:cantas.user.id}],isArchived:!1}).setSort({created:-1,title:1}).fetch({success:function(b){a("body div.process-loading").hide(),d.setContentView(new cantas.views.CardListView({collection:b,title:"My Cards"}).render()),c.switchView(d)},error:function(){return cantas.utils.renderTimeoutBox(),!1}})},joinBoard:function(a){var b=cantas.socket,c=this;cantas.utils.isBrowserVersionLow()?cantas.utils.renderBrowserVesionPrompt():(b.once("joined-board",function(b){if(1===b.ok)"closed"===b.message?(alert("This board is closed by board creator. Any further operation, please contact the creator."),c.navigate("boards/mine",{trigger:!0,replace:!0})):"nologin"===b.message?(c.navigate("boards/mine",{trigger:!0,replace:!0}),alert("You can't access a private Board! Please let Board admin invite you as an board member firstly!")):(c.navigate("boards/mine",{trigger:!0,replace:!0}),cantas.utils.renderTimeoutBox());else if(0===b.ok){d="isMember"===b.message?!0:!1;var e=c.setupVisitorCollection(b.visitors);c.renderBoard(a,e)}else c.navigate("boards/mine",{trigger:!0,replace:!0}),alert("You came across a unknown bug, please file a bug to cantas-dev-list@redhat.com and help cantas project, thanks a lot.")}),b.emit("join-board",a))},setupVisitorCollection:function(a){return new cantas.models.BoardVisitorCollection(a)},renderBoard:function(b,c){if(-1!==window.location.href.indexOf("?"))var e=cantas.utils.getQueryStringParams();-1!==b.indexOf("?")&&(b=b.split("?")[0]);var f=this,g=new cantas.models.Board({_id:b});g.fetch({success:function(g,h,i){var j=new cantas.views.BoardView({model:g,response:h,options:i,isMember:d,visitors:c,state:e});f.switchView(j),f.navigate("board/"+b+"/"+a.slug(h.title),{trigger:!1,replace:!0})},error:function(){console.log("fail")}})},renderCardDetail:function(b){var c=this,d=new cantas.models.Card({_id:b});d.fetch({success:function(d,e){var f=new cantas.models.List({_id:e.listId});f.fetch({success:function(d,e){c.navigate("board/"+e.boardId,{trigger:!0,replace:!0});var f=setInterval(function(){var c=a("#"+b).last().find(".card-title");c.length>0&&(c.trigger("click"),clearInterval(f))},100)}})}})},help:function(){if(cantas.utils.isBrowserVersionLow())cantas.utils.renderBrowserVesionPrompt();else{var a=new cantas.views.HelpView;this.switchView(a,{title:"Help"})}},accountSettings:function(){if(cantas.utils.isBrowserVersionLow())return cantas.utils.renderBrowserVesionPrompt();var a=(new cantas.views.DashboardView).render();a.setNavigationView((new cantas.views.DashboardNavigationView).render().setActive("nav-account-settings")),a.setContentView(new cantas.views.accountSettingsView({title:"Account Settings"}).render()),this.switchView(a)},welcome:function(){var a=new cantas.views.WelcomeView;this.switchView(a,{title:"Welcome"})},search:function(a){var b=new cantas.views.SearchView;this.switchView(b,{title:'Search results for: "'+a+'"'}),b.search(a)},newBoard:function(){var b="new",c=this;a.ajax({url:"/api/"+b,success:function(a){c.joinBoard(a.boardId)},error:function(){return cantas.utils.renderTimeoutBox(),!1}})}});cantas.appRouter=new e,c.history.start({pushState:!0}),cantas.navigateTo=function(a){cantas.appRouter.navigate(a,{trigger:!0})},cantas.socket.on("cover:update",function(a){var b=cantas.utils.getCardModelById(a.cardId);b.set("cover",a.cover)}),cantas.socket.on("badges:update",function(a){var b=cantas.utils.getCardModelById(a.cardId);b.set("badges",a.badges)}),cantas.socket.on("alert-import-trello-complete",function(){cantas.utils.renderImportTrelloBox()})}(jQuery,_,Backbone));